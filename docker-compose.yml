name: transcendence
services:
  web-application-firewall:
    build:
      context: ./services/web-application-firewall
      dockerfile: Dockerfile
      args:
        MODSEC_VERSION: ${MODSEC_VERSION:-3.0.8}
        NGINX_VERSION: ${NGINX_VERSION:-1.22.1}
        LMDB_VERSION: ${LMDB_VERSION:-0.9.29}
    user: "1000:1000"
    entrypoint: ["sh","-lc","while ! (test -s /etc/nginx/certs/server.crt && test -s /etc/nginx/certs/server.key && test -s /etc/nginx/certs/ca.crt); do sleep 0.5; done; exec \"$@\""]
    depends_on:
      api-gateway:
        condition: service_started
    ports:
      - "8443:8443"
    volumes:
      - ./services/web-application-firewall/configs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./services/web-application-firewall/modsecurity.d:/etc/modsecurity.d:ro
      - ./services/web-application-firewall/html:/usr/share/nginx/html:ro
      - web-application-firewall-certs:/etc/nginx/certs:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  web-application-firewall-agent:
    image: hashicorp/vault:1.20.2
    user: "1000:1000"
    command: ["agent","-config=/agents/service-server-agent.hcl"]
    depends_on:
      web-application-firewall:
        condition: service_started
    pid: "service:web-application-firewall"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "web-application-firewall"
      SERVICE_DNS:  "localhost"
      SERVICE_ALT_NAMES: "ft-transcendence.at,localhost"
      APPROLE_AGENT_NAME: "web-application-firewall-agent-rotator"
      PKI_ROLE_SERVER: "ft-transcendence"
      PKI_ROLE_CLIENT: "vault-clients-internal"
    volumes:
      - web-application-firewall-agent-certs:/agent/certs:rw
      - web-application-firewall-certs:/service/certs:rw
      - web-application-firewall-agent-approle:/approle:rw
      - agent-server-config:/agents:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    user: "1000:1000"
    entrypoint: ["sh","-lc","while ! (test -s /app/certs/server.crt && test -s /app/certs/server.key && test -s /app/certs/ca.crt && test -s /app/certs/client.crt && test -s /app/certs/client.key); do sleep 0.5; done; exec \"$@\""]
    depends_on:
      auth-user-service:
        condition: service_started
      game-service:
        condition: service_started
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      GAME_SERVICE_UPSTREAM: https://game-service:3001
      AUTH_USER_SERVICE_UPSTREAM: https://auth-user-service:3002
      CERT_DIR: /app/certs
      APPROLE_DIR: /approle-service
    volumes:
      - api-gateway-service-certs:/app/certs:ro
      - api-gateway-approle-service:/approle-service:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  api-gateway-agent:
    image: hashicorp/vault:1.20.2
    user: "1000:1000"
    command: ["agent","-config=/agents/service-server-client-agent.hcl"]
    depends_on:
      api-gateway:
        condition: service_started
    pid: "service:api-gateway"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "api-gateway"
      SERVICE_DNS:  "api-gateway"
      SERVICE_ALT_NAMES: "api-gateway"
      APPROLE_AGENT_NAME:   "api-gateway-agent-rotator"
      APPROLE_SERVICE_NAME: "api-gateway"
      PKI_ROLE_SERVER: "api-gateway-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
    volumes:
      - api-gateway-agent-certs:/agent/certs:rw
      - api-gateway-service-certs:/service/certs:rw
      - api-gateway-agent-approle:/approle:rw
      - api-gateway-approle-service:/approle-service:rw
      - agent-server-client-config:/agents:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /service/certs/client.crt; test -s /service/certs/client.key; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  game-service:
    build: ./services/game-service
    user: "1000:1000"
    entrypoint: ["sh","-lc","while ! (test -s /app/certs/server.crt && test -s /app/certs/server.key && test -s /app/certs/ca.crt); do sleep 0.5; done; exec \"$@\""]
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      JWT_SECRET: ${JWT_SECRET}
      API_GATEWAY_UPSTREAM: https://api-gateway:3000
      CERT_DIR: /app/certs
    volumes:
      - game-service-certs:/app/certs:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  game-service-agent:
    image: hashicorp/vault:1.20.2
    user: "1000:1000"
    command: ["agent","-config=/agents/service-server-agent.hcl"]
    depends_on:
      game-service:
        condition: service_started
    pid: "service:game-service"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "game-service"
      SERVICE_DNS:  "game-service"
      SERVICE_ALT_NAMES: "game-service"
      APPROLE_AGENT_NAME: "game-service-agent-rotator"
      PKI_ROLE_SERVER: "game-service-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
    volumes:
      - game-service-agent-certs:/agent/certs:rw
      - game-service-certs:/service/certs:rw
      - game-service-agent-approle:/approle:rw
      - agent-server-config:/agents:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  auth-user-service:
    build: ./services/auth-user-service
    user: "1000:1000"
    entrypoint: ["sh","-lc","while ! (test -s /app/certs/server.crt && test -s /app/certs/server.key && test -s /app/certs/ca.crt && test -s /app/certs/client.crt && test -s /app/certs/client.key); do sleep 0.5; done; exec \"$@\""]
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      JWT_SECRET: ${JWT_SECRET}
      CERT_DIR: /app/certs
      APPROLE_DIR: /approle-service
    volumes:
      - database:/app/database
      - auth-user-service-certs:/app/certs:ro
      - auth-user-service-approle:/approle-service:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  auth-user-service-agent:
    image: hashicorp/vault:1.20.2
    user: "1000:1000"
    command: ["agent","-config=/agents/service-server-client-agent.hcl"]
    depends_on:
      auth-user-service:
        condition: service_started
    pid: "service:auth-user-service"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "auth-user-service"
      SERVICE_DNS:  "auth-user-service"
      SERVICE_ALT_NAMES: "auth-user-service"
      APPROLE_AGENT_NAME:   "auth-user-service-agent-rotator"
      APPROLE_SERVICE_NAME: "auth-user-service"
      PKI_ROLE_SERVER: "auth-user-service-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
    volumes:
      - auth-user-service-agent-certs:/agent/certs:rw
      - auth-user-service-certs:/service/certs:rw
      - auth-user-service-agent-approle:/approle:rw
      - auth-user-service-approle:/approle-service:rw
      - agent-server-client-config:/agents:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /service/certs/client.crt; test -s /service/certs/client.key; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped


  cli-client:
    build: ./cli
    network_mode: host
    profiles:
      - cli
    volumes:
      - cli-certs:/app/certs:ro

  vault-seed-config:
    image: alpine:3.20
    profiles: [ "dev", "prod" ]
    volumes:
      - ./services/vault/config/:/source:ro
      - ./services/vault/scripts/:/scripts:ro
      - ./services/vault/agents/:/source_agents:ro
      - vault-dev-config:/dest-dev
      - vault-1-config:/dest-1
      - vault-2-config:/dest-2
      - vault-3-config:/dest-3
      - vault-1-agent-config:/dest-1-agent
      - vault-2-agent-config:/dest-2-agent
      - vault-3-agent-config:/dest-3-agent
      - agent-server-config:/dest-agent-server-config
      - agent-server-client-config:/dest-agent-server-client-config
    entrypoint: ["sh", "/scripts/vault-seed-config.sh"]
    restart: "no"

  # --- Dev: Single node with local UI/CLI
  vault-dev-seed:
    image: alpine:3.20
    profiles: [ "dev" ]          # nur mit --profile dev
    volumes:
      - vault-dev-runtime-certs:/destination
      - ./services/vault/scripts/:/scripts:ro
    environment:
      CN: "vault-dev"
      EXTRASAN: ",DNS:localhost,IP:127.0.0.1"
      DAYS: "7"
      DEST: "/destination"
    entrypoint: ["sh", "/scripts/vault-seed-cert.sh"]
    restart: "no"

  vault-bootstrap-dev:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile  # multi-stage: vault CLI + jq
    profiles: [ "dev" ]
    depends_on: [ vault-dev ]
    entrypoint: [ "sh", "/scripts/vault-bootstrap-dev.sh" ]
    environment:
      VAULT_ADDR: "https://vault-dev:8200"
      VAULT_SKIP_VERIFY: "1"
      ENABLE_MTLS_AT_END: "true"
      HOST_UID: "${HOST_UID:-1000}"               # Fallback 1000
      HOST_GID: "${HOST_GID:-1000}"               # Fallback 1000
    volumes:
      - ./services/vault/scripts:/scripts:ro                             # <— Skript nur gemountet
      - ./services/vault/policies:/policies:ro                           # <— Policies nur gemountet
      - vault-dev-runtime-certs:/certs/vault-dev:rw                       # RW für client.crt/key
      - vault-dev-config:/vault/config:rw                                 # RO für vault-dev.hcl
      - vault-dev-logs:/vault/logs                                          # RW für keys.json / Marker
      - ./services/ai-opponent/certs/:/certs/ai-opponent/:rw             # RW für ai-opponent
      - ./services/api-gateway/certs/:/certs/api-gateway/:rw             # RW für api-gateway
      - ./services/auth-user-service/certs/:/certs/auth-user-service/:rw # RW für auth-user-service
      - ./services/game-service/certs/:/certs/game-service/:rw           # RW für game-service
      - ./frontend-src/certs/:/certs/vite/:rw                           # RW für frontend
    networks: [ api-network ]
    restart: "no"

  vault-dev:
    image: hashicorp/vault:1.20
    profiles: [ "dev" ]
    user: "0:0"
    entrypoint: vault server -config=/vault/config/vault-dev.hcl
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    volumes:
      - vault-dev-config:/vault/config:rw
      - vault-dev-runtime-certs:/vault/certs:ro
      - vault-dev-data:/vault/raft
      - vault-dev-logs:/vault/logs
    ports:
      - "127.0.0.1:8200:8200"
      - "127.0.0.1:8202:8202"
    networks: [ api-network ]



  # --- Prod/Staging: 3-node cluster
  vault-1-seed:
    image: alpine:3.20
    profiles: [ "prod" ]
    environment:
      CN: "vault-1"
      EXTRASAN: ",DNS:localhost"
      DEST: "/destination"
      DAYS: "7"
      HOST_UID: "1000"
      HOST_GID: "1000"
    volumes:
      - vault-1-runtime-certs:/destination
      - ./services/vault/scripts/:/scripts:ro
    entrypoint: ["sh", "/scripts/vault-seed-cert.sh"]
    restart: "no"

  vault-bootstrap-prod:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile
    profiles: [ "prod" ]
    depends_on: [ vault-1 ]
    user: "1000:1000"
    pid: "service:vault-1"
    entrypoint: [ "sh", "/scripts/vault-bootstrap-prod.sh" ]
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      VAULT_SKIP_VERIFY: "1"
      ENABLE_MTLS_AT_END: "true"
      VAULT_UID: "1000"
      VAULT_GID: "1000"
      VAULT_KEY_DIR: "/vault/keys"
    volumes:
      - ./services/vault/scripts:/scripts:ro
      - ./services/vault/policies:/policies:ro

      # Node runtime cert volumes (initial seed)
      - vault-1-runtime-certs:/certs/vault-1:rw
      - vault-2-runtime-certs:/certs/vault-2:rw
      - vault-3-runtime-certs:/certs/vault-3:rw

      # Service Agents (initial seed)
      - web-application-firewall-agent-certs:/certs/web-application-firewall:rw
      - web-application-firewall-agent-approle:/approle/web-application-firewall-agent:rw

      - api-gateway-agent-certs:/certs/api-gateway:rw
      - api-gateway-agent-approle:/approle/api-gateway-agent:rw

      - auth-user-service-agent-certs:/certs/auth-user-service:rw
      - auth-user-service-agent-approle:/approle/auth-user-service-agent:rw

      - game-service-agent-certs:/certs/game-service:rw
      - game-service-agent-approle:/approle/game-service-agent:rw

      # Config volumes (seeded by vault-seed-config)
      - vault-1-config:/vault/config:rw

      # Keys/state for unseal service
      - vault-keys:/vault/keys:rw

    networks: [ api-network ]
    restart: "no"

  vault-unseal-prod:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile
    profiles: [ "prod" ]
    depends_on: [ vault-1 ]
    command: [ "sh", "/scripts/vault-unseal-prod.sh" ]
    volumes:
      - ./services/vault/scripts:/scripts:ro
      - vault-keys:/vault/keys:ro
    networks: [ api-network ]
    restart: "no"

  vault-1:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    command: [ "server", "-config=/vault/config/vault-1.hcl" ]
    cap_add: [ "IPC_LOCK" ]
    ports: [ "127.0.0.1:18200:8300"]
    ulimits: { memlock: -1 }
    volumes:
      - vault-1-config:/vault/config:ro
      - vault-1-runtime-certs:/vault/certs:ro   # initiale Zertifikate von vault-1-seed
      - vault-1-data:/vault/raft
      - vault-1-logs:/vault/logs
    expose: [ "8200" ]
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-1-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    pid: "service:vault-1"
    depends_on: [ vault-1 ]
    command: [ "agent", "-config=/vault/agents/vault-1-agent.hcl" ]
    volumes:
      - vault-1-runtime-certs:/vault/certs:rw
      - vault-1-agent-role:/approle:rw
      - vault-1-agent-config:/vault/agents:ro
    tmpfs:
      - /run/vault:rw,size=4m,mode=0700
      - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-2:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    command: [ "server", "-config=/vault/config/vault-2.hcl" ]
    depends_on: [ vault-1 ]
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    ports: [ "127.0.0.1:28200:8300" ]
    volumes:
      - vault-2-config:/vault/config:ro
      - vault-2-runtime-certs:/vault/certs:ro
      - vault-2-data:/vault/raft
      - vault-2-logs:/vault/logs
    expose: [ "8200" ]
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
  
  vault-2-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    pid: "service:vault-2"
    depends_on: [ vault-2 ]
    command: [ "agent", "-config=/vault/agents/vault-2-agent.hcl" ]
    volumes:
      - vault-2-runtime-certs:/vault/certs:rw
      - vault-2-agent-role:/approle:rw
      - vault-2-agent-config:/vault/agents:ro
    tmpfs:
     - /run/vault:rw,size=4m,mode=0700
     - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped


  vault-3:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    command: [ "server", "-config=/vault/config/vault-3.hcl" ]   # mit retry_join auf vault-1
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    ports: [ "127.0.0.1:38200:8300" ]
    volumes:
      - vault-3-config:/vault/config:ro
      - vault-3-runtime-certs:/vault/certs:ro
      - vault-3-data:/vault/raft
      - vault-3-logs:/vault/logs
    expose: [ "8200" ]
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-3-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "1000:1000"
    pid: "service:vault-3"
    depends_on: [ vault-3 ]
    command: [ "agent", "-config=/vault/agents/vault-3-agent.hcl" ]
    volumes:
      - vault-3-runtime-certs:/vault/certs:rw
      - vault-3-agent-role:/approle:rw
      - vault-3-agent-config:/vault/agents:ro
    tmpfs:
     - /run/vault:rw,size=4m,mode=0700
     - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
networks:
  api-network:
    driver: bridge

volumes:

# SERVICES
  database: {}
  web-application-firewall-certs: {}
  game-service-certs: {}
  cli-certs: {}
  service-agent-config: {}
  web-application-firewall-agent-certs: {}
  web-application-firewall-agent-approle: {}
  api-gateway-service-certs: {}
  api-gateway-agent-certs: {}
  api-gateway-agent-approle: {}
  api-gateway-approle-service: {}
  game-service-agent-certs: {}
  game-service-agent-approle: {}
  auth-user-service-agent-certs: {}
  auth-user-service-certs: {}
  auth-user-service-agent-approle: {}
  auth-user-service-approle: {}

# VAULT
  vault-dev-config: {}
  vault-dev-data: {}
  vault-dev-logs: {}
  vault-dev-runtime-certs: {}

  vault-1-config: {}
  vault-1-data: {}
  vault-1-logs: {}
  vault-1-runtime-certs: {}

  vault-2-config: {}
  vault-2-data: {}
  vault-2-logs: {}
  vault-2-runtime-certs: {}

  vault-3-config: {}
  vault-3-data: {}
  vault-3-logs: {}
  vault-3-runtime-certs: {}

  vault-1-agent-config: {}
  vault-1-agent-role: {}
  vault-2-agent-config: {}
  vault-2-agent-role: {}
  vault-3-agent-config: {}
  vault-3-agent-role: {}
  vault-keys: {}
  agent-server-config: {}
  agent-server-client-config: {}