name: transcendence
services:
  setup-volume-ownerships:
    image: alpine:3.20
    profiles: ["dev", "prod"]
    user: "0:0"
    environment:
      APP_UID: "100"
      APP_GID: "100"
      CERT_DIRS: "/waf/service-certs /waf/agent-certs /apigw/service-certs /apigw/agent-certs /game/service-certs /game/agent-certs /auth/service-certs /auth/agent-certs /vault1/runtime-certs /vault2/runtime-certs /vault3/runtime-certs /shared/agent-hup /ai/service-certs /ai/agent-certs"
      APPROLE_DIRS: "/waf/approle /apigw/approle-agent /apigw/approle-service /game/approle-agent /auth/approle-agent /auth/approle-service /ai/approle-agent /vault1/approle-agent /vault2/approle-agent /vault3/approle-agent"
      RAFT_DIRS: "/vault1/raft /vault2/raft /vault3/raft"
      LOG_DIRS: "/vault1/logs /vault2/logs /vault3/logs"
      EXTRA_DIRS: "/shared/keys /auth/database /ai/ai_model /waf/avatars /auth/uploads/avatars"
    command: ["sh","-lc","/scripts/setup_volume_ownerships.sh"]
    volumes:
      - ./services/vault/scripts/setup_volume_ownerships.sh:/scripts/setup_volume_ownerships.sh:ro
      # WAF
      - web-application-firewall-certs:/waf/service-certs
      - web-application-firewall-agent-certs:/waf/agent-certs
      - web-application-firewall-agent-approle:/waf/approle
      - avatar-uploads:/waf/avatars
      # API Gateway
      - api-gateway-service-certs:/apigw/service-certs
      - api-gateway-agent-certs:/apigw/agent-certs
      - api-gateway-agent-approle:/apigw/approle-agent
      - api-gateway-approle-service:/apigw/approle-service
      # Game Service
      - game-service-certs:/game/service-certs
      - game-service-agent-certs:/game/agent-certs
      - game-service-agent-approle:/game/approle-agent
      # Auth User Service
      - auth-user-service-certs:/auth/service-certs
      - auth-user-service-agent-certs:/auth/agent-certs
      - auth-user-service-agent-approle:/auth/approle-agent
      - auth-user-service-approle:/auth/approle-service
      - database:/auth/database
      - database-upload:/auth/uploads/avatars

      # AI Opponent
      - ai-opponent-agent-approle:/ai/approle-agent
      - ai-opponent-agent-certs:/ai/agent-certs
      - ai-opponent-certs:/ai/service-certs
      - ai-opponent-model:/ai/ai_model


      # Vault Nodes
      - vault-keys:/vault/keys
      - vault-1-runtime-certs:/vault1/runtime-certs
      - vault-2-runtime-certs:/vault2/runtime-certs
      - vault-3-runtime-certs:/vault3/runtime-certs
      - vault-1-agent-role:/vault1/approle-agent
      - vault-2-agent-role:/vault2/approle-agent
      - vault-3-agent-role:/vault3/approle-agent
      - vault-1-data:/vault1/raft
      - vault-2-data:/vault2/raft
      - vault-3-data:/vault3/raft
      - vault-1-logs:/vault1/logs
      - vault-2-logs:/vault2/logs
      - vault-3-logs:/vault3/logs
      # Shared
      - vault-keys:/shared/keys
      - vault-agent-hup:/shared/agent-hup
    restart: "no"

  web-application-firewall:
    build:
      context: ./services/web-application-firewall
      dockerfile: Dockerfile
      args:
        MODSEC_VERSION: ${MODSEC_VERSION:-3.0.8}
        NGINX_VERSION: ${NGINX_VERSION:-1.22.1}
        LMDB_VERSION: ${LMDB_VERSION:-0.9.29}
    user: "100:100"
    tmpfs:
      - /var/cache/nginx:rw,noexec,nodev,nosuid,size=256m,uid=100,gid=100
      - /var/log/nginx/:rw,noexec,nodev,nosuid,size=8m,uid=100,gid=100
      - /var/run:rw,noexec,nodev,nosuid,size=8m,uid=100,gid=100
    depends_on:
      api-gateway:
        condition: service_started
    ports:
      - "8443:8443"
    volumes:
      - ./services/web-application-firewall/configs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./services/web-application-firewall/modsecurity.d:/etc/modsecurity.d:ro
      - ./services/web-application-firewall/html:/usr/share/nginx/html:rw
      - database-upload:/uploads/avatars:rw  # ✅ EKLE
      - web-application-firewall-certs:/etc/nginx/certs:ro
      # - avatar-uploads:/usr/share/nginx/html/imgs/avatars:rw
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  web-application-firewall-agent:
    profiles: ["prod"]
    image: hashicorp/vault:1.20.2
    user: "100:100"
    entrypoint: vault agent -config=/agents/service-server-agent.hcl
    depends_on:
      web-application-firewall:
        condition: service_started
    pid: "service:web-application-firewall"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "ft-transcendence"
      SERVICE_DNS:  "localhost"
      SERVICE_ALT_NAMES: "ft-transcendence.at,localhost"
      APPROLE_AGENT_NAME: "web-application-firewall-rotator"
      PKI_ROLE_SERVER: "ft-transcendence"
      PKI_ROLE_CLIENT: "vault-clients-internal"
      SKIP_SETCAP: "true"
    volumes:
      - web-application-firewall-agent-certs:/agent/certs:rw
      - web-application-firewall-certs:/service/certs:rw
      - web-application-firewall-agent-approle:/approle:rw
      - agent-server-config:/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700,uid=100,gid=100
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    user: "100:100"
    depends_on:
      auth-user-service:
        condition: service_started
      game-service:
        condition: service_started
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      GAME_SERVICE_UPSTREAM: https://game-service:3001
      AI_OPPONENT_SERVICE_UPSTREAM: https://ai-opponent:3003
      AUTH_USER_SERVICE_UPSTREAM: https://auth-user-service:3002
      LIVE_CHAT_UPSTREAM: https://localhost:3004
      CERT_DIR: /app/certs
      APPROLE_DIR: /approle-service
      VAULT_ADDR: "https://vault-1:8200"
    volumes:
      - api-gateway-service-certs:/app/certs:ro
      - api-gateway-approle-service:/approle-service:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  api-gateway-agent:
    profiles: ["prod"]
    image: hashicorp/vault:1.20.2
    user: "100:100"
    entrypoint: vault agent -config=/agents/service-server-client-agent.hcl
    depends_on:
      api-gateway:
        condition: service_started
    pid: "service:api-gateway"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "api-gateway"
      SERVICE_DNS:  "api-gateway"
      SERVICE_ALT_NAMES: "api-gateway"
      APPROLE_AGENT_NAME:   "api-gateway-rotator"
      APPROLE_SERVICE_NAME: "api-gateway"
      PKI_ROLE_SERVER: "api-gateway-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
      SKIP_SETCAP: "true"
    volumes:
      - api-gateway-agent-certs:/agent/certs:rw
      - api-gateway-service-certs:/service/certs:rw
      - api-gateway-agent-approle:/approle:rw
      - api-gateway-approle-service:/approle-service:rw
      - agent-server-client-config:/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700,uid=100,gid=100
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /service/certs/client.crt; test -s /service/certs/client.key; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  game-service:
    build: ./services/game-service
    user: "100:100"
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      API_GATEWAY_UPSTREAM: https://api-gateway:3000
      CERT_DIR: /app/certs
      AI_OPPONENT_SERVICE_UPSTREAM: https://ai-opponent:3003
      AUTH_USER_SERVICE_UPSTREAM: https://auth-user-service:3002
    volumes:
      - game-service-certs:/app/certs:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  game-service-agent:
    profiles: ["prod"]
    image: hashicorp/vault:1.20.2
    user: "100:100"
    entrypoint: vault agent -config=/agents/service-server-agent.hcl
    depends_on:
      game-service:
        condition: service_started
    pid: "service:game-service"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "game-service"
      SERVICE_DNS:  "game-service"
      SERVICE_ALT_NAMES: "game-service"
      APPROLE_AGENT_NAME: "game-service-rotator"
      PKI_ROLE_SERVER: "game-service-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
      SKIP_SETCAP: "true"
    volumes:
      - game-service-agent-certs:/agent/certs:rw
      - game-service-certs:/service/certs:rw
      - game-service-agent-approle:/approle:rw
      - agent-server-config:/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700,uid=100,gid=100
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped


  ai-opponent:
    build: ./services/ai-opponent
    user: "100:100"
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      CERT_DIR: /app/certs
      API_GATEWAY_UPSTREAM: https://api-gateway:3000
      GAME_SERVICE_UPSTREAM: https://game-service:3001
      MODEL_DIR: /app/ai_model
    volumes:
      - ai-opponent-certs:/app/certs:ro
      - ai-opponent-model:/app/ai_model:rw
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  ai-opponent-agent:
    profiles: ["prod"]
    image: hashicorp/vault:1.20.2
    user: "100:100"
    entrypoint: vault agent -config=/agents/service-server-agent.hcl
    depends_on:
      ai-opponent:
        condition: service_started
    pid: "service:ai-opponent"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "ai-opponent"
      SERVICE_DNS:  "ai-opponent"
      SERVICE_ALT_NAMES: "ai-opponent"
      APPROLE_AGENT_NAME: "ai-opponent-rotator"
      PKI_ROLE_SERVER: "ai-opponent-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
      SKIP_SETCAP: "true"
    volumes:
      - ai-opponent-agent-certs:/agent/certs:rw
      - ai-opponent-certs:/service/certs:rw
      - ai-opponent-agent-approle:/approle:rw
      - agent-server-config:/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700,uid=100,gid=100
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  auth-user-service:
    build: ./services/auth-user-service
    user: "100:100"
    environment:
      NODE_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-info}
      CERT_DIR: /app/certs
      APPROLE_DIR: /approle-service
      VAULT_ADDR: "https://vault-1:8200"
      FRONTEND_URL: "web-application-firewall:8443"
      AVATAR_UPLOAD_DIR: /app/uploads/avatars
    volumes:
      - database:/app/database
      - database-upload:/app/uploads/avatars:rw

      - auth-user-service-certs:/app/certs:ro
      - auth-user-service-approle:/approle-service:ro
    security_opt:
      - no-new-privileges:true
    networks:
      - api-network
    restart: unless-stopped

  auth-user-service-agent:
    profiles: ["prod"]
    image: hashicorp/vault:1.20.2
    user: "100:100"
    entrypoint: vault agent -config=/agents/service-server-client-agent.hcl
    depends_on:
      auth-user-service:
        condition: service_started
    pid: "service:auth-user-service"
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      SERVICE_NAME: "auth-user-service"
      SERVICE_DNS:  "auth-user-service"
      SERVICE_ALT_NAMES: "auth-user-service"
      APPROLE_AGENT_NAME:   "auth-user-service-rotator"
      APPROLE_SERVICE_NAME: "auth-user-service"
      PKI_ROLE_SERVER: "auth-user-service-internal"
      PKI_ROLE_CLIENT: "vault-clients-internal"
      SKIP_SETCAP: "true"
    volumes:
      - auth-user-service-agent-certs:/agent/certs:rw
      - auth-user-service-certs:/service/certs:rw
      - auth-user-service-agent-approle:/approle:rw
      - auth-user-service-approle:/approle-service:rw
      - agent-server-client-config:/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:size=4m,mode=0700,uid=100,gid=100
      - /tmp:size=8m,mode=1777
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "set -e; test -s /service/certs/server.crt; test -s /service/certs/server.key; test -s /service/certs/ca.crt; test -s /service/certs/client.crt; test -s /service/certs/client.key; test -s /agent/certs/client.crt; test -s /agent/certs/client.key"]
      interval: 5s
      timeout: 2s
      retries: 12
      start_period: 10s
    networks:
      - api-network
    restart: unless-stopped

  cli-client:
    build: ./cli
    network_mode: host
    profiles:
      - cli
    volumes:
      - cli-certs:/app/certs:ro

  # for all vault services (dev + prod)
  vault-seed-config:
    image: alpine:3.20
    profiles: [ "dev", "prod" ]      
    volumes:
      - ./services/vault/config/:/source:ro
      - ./services/vault/scripts/:/scripts:ro
      - ./services/vault/agents/:/source_agents:ro
      - ./services/vault/scripts/debounce_hup.sh:/scripts/debounce_hup.sh:ro
      - vault-agent-hup:/run/vault
      - vault-dev-config:/dest-dev
      - vault-1-config:/dest-1
      - vault-2-config:/dest-2
      - vault-3-config:/dest-3
      - vault-1-agent-config:/dest-1-agent
      - vault-2-agent-config:/dest-2-agent
      - vault-3-agent-config:/dest-3-agent
      - agent-server-config:/dest-agent-server-config
      - agent-server-client-config:/dest-agent-server-client-config
    entrypoint: ["sh", "/scripts/vault-seed-config.sh"]
    restart: "no"

  # --- Dev: Single node with local UI/CLI
  vault-dev-seed:
    image: alpine:3.20
    profiles: [ "dev" ]          # nur mit --profile dev
    volumes:
      - vault-dev-runtime-certs:/destination
      - ./services/vault/scripts/:/scripts:ro
    environment:
      CN: "vault-dev"
      EXTRASAN: ",DNS:localhost,IP:127.0.0.1"
      DAYS: "7"
      DEST: "/destination"
    entrypoint: ["sh", "/scripts/vault-seed-cert.sh"]
    restart: "no"

  vault-bootstrap-dev:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile  # multi-stage: vault CLI + jq
    profiles: [ "dev" ]
    depends_on: [ vault-dev ]
    entrypoint: [ "sh", "/scripts/vault-bootstrap-dev.sh" ]
    environment:
      VAULT_ADDR: "https://vault-dev:8200"
      VAULT_SKIP_VERIFY: "1"
      ENABLE_MTLS_AT_END: "true"
      HOST_UID: "${HOST_UID:-100}"               # Fallback 100
      HOST_GID: "${HOST_GID:-100}"               # Fallback 100
    volumes:
      - ./services/vault/scripts:/scripts:ro                             # <— Skript nur gemountet
      - ./services/vault/policies:/policies:ro                           # <— Policies nur gemountet
      - vault-dev-runtime-certs:/certs/vault-dev:rw                       # RW für client.crt/key
      - vault-dev-config:/vault/config:rw                                 # RO für vault-dev.hcl
      - vault-dev-logs:/vault/logs                                          # RW für keys.json / Marker
      - ./services/ai-opponent/certs/:/certs/ai-opponent/:rw             # RW für ai-opponent
      - ./services/api-gateway/certs/:/certs/api-gateway/:rw             # RW für api-gateway
      - ./services/auth-user-service/certs/:/certs/auth-user-service/:rw # RW für auth-user-service
      - ./services/game-service/certs/:/certs/game-service/:rw           # RW für game-service
      - ./services/live-chat/certs/:/certs/live-chat/:rw                  # RW für Live-chat
      - ./frontend-src/certs/:/certs/vite/:rw                           # RW für frontend
      - ./services/auth-user-service/certs/approle/:/approle/auth-user-service/:rw # RW für auth-user-service
      - ./services/api-gateway/certs/approle/:/approle/api-gateway/:rw             # RW für api-gateway
    networks: [ api-network ]
    restart: "no"

  vault-dev:
    image: hashicorp/vault:1.20
    profiles: [ "dev" ]
    user: "0:0"
    entrypoint: vault server -config=/vault/config/vault-dev.hcl
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    volumes:
      - vault-dev-config:/vault/config:rw
      - vault-dev-runtime-certs:/vault/certs:ro
      - vault-dev-data:/vault/raft
      - vault-dev-logs:/vault/logs
    ports:
      - "127.0.0.1:8200:8200"
      - "127.0.0.1:8202:8202"
    networks: [ api-network ]

  # --- Prod/Staging: 3-node cluster
  vault-1-seed:
    image: alpine:3.20
    profiles: [ "prod" ]
    environment:
      CN: "vault-1"
      EXTRASAN: ",DNS:localhost"
      DEST: "/destination"
      DAYS: "7"
      HOST_UID: "100"
      HOST_GID: "100"
    volumes:
      - vault-1-runtime-certs:/destination
      - ./services/vault/scripts/:/scripts:ro
    entrypoint: ["sh", "/scripts/vault-seed-cert.sh"]
    restart: "no"

  vault-bootstrap-prod:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile
    profiles: [ "prod" ]
    depends_on: [ vault-1 ]
    user: "0:0"
    pid: "service:vault-1"
    entrypoint: [ "sh", "/scripts/vault-bootstrap-prod.sh" ]
    environment:
      VAULT_ADDR: "https://vault-1:8200"
      VAULT_SKIP_VERIFY: "1"
      ENABLE_MTLS_AT_END: "true"
      VAULT_UID: "100"
      VAULT_GID: "100"
      VAULT_KEY_DIR: "/vault/keys"
    volumes:
      - ./services/vault/scripts:/scripts:ro
      - ./services/vault/policies:/policies:ro
      - ./services/vault/config/:/src_config:ro
      # Node runtime cert volumes (initial seed)
      - vault-1-runtime-certs:/certs/vault-1:rw
      - vault-2-runtime-certs:/certs/vault-2:rw
      - vault-3-runtime-certs:/certs/vault-3:rw

      - vault-1-agent-role:/approle/vault-1-agent:rw
      - vault-2-agent-role:/approle/vault-2-agent:rw
      - vault-3-agent-role:/approle/vault-3-agent:rw

      # Public certificates
      - web-application-firewall-certs:/certs/web-application-firewall:rw
      # Service Agents (initial seed)

      - web-application-firewall-agent-certs:/certs/web-application-firewall-agent:rw
      - web-application-firewall-agent-approle:/approle/web-application-firewall-agent:rw

      - api-gateway-agent-certs:/certs/api-gateway-agent:rw
      - api-gateway-agent-approle:/approle/api-gateway-agent:rw

      - auth-user-service-agent-certs:/certs/auth-user-service-agent:rw
      - auth-user-service-agent-approle:/approle/auth-user-service-agent:rw

      - game-service-agent-certs:/certs/game-service-agent:rw
      - game-service-agent-approle:/approle/game-service-agent:rw

      - ai-opponent-agent-certs:/certs/ai-opponent-agent:rw
      - ai-opponent-agent-approle:/approle/ai-opponent-agent:rw

      # Server certificates
      - api-gateway-service-certs:/certs/api-gateway:rw
      - auth-user-service-certs:/certs/auth-user-service:rw
      - game-service-certs:/certs/game-service:rw
      - ai-opponent-certs:/certs/ai-opponent:rw

      # Config volumes (seeded by vault-seed-config)
      - vault-1-config:/vault/config:rw

      # Keys/state for unseal service
      - vault-keys:/vault/keys:rw

    networks: [ api-network ]
    restart: "no"

  vault-unseal-prod:
    build:
      context: .
      dockerfile: services/vault/bootstrap/Dockerfile
    profiles: [ "prod" ]
    depends_on: [ vault-1 ]
    command: [ "sh", "/scripts/vault-unseal-prod.sh" ]
    volumes:
      - ./services/vault/scripts:/scripts:ro
      - vault-keys:/vault/keys:ro
    networks: [ api-network ]
    restart: "no"

  vault-1:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    entrypoint: vault server -config=/vault/config/vault-1.hcl
    cap_add: [ "IPC_LOCK" ]
    ports: [ "127.0.0.1:18200:8300"] # Vault ui erreichbar unter https://localhost:18200
    ulimits: { memlock: -1 }
    environment:
      SKIP_SETCAP: "1"
      SKIP_CHOWN: "true"
    volumes:
      - vault-1-config:/vault/config:ro
      - vault-1-runtime-certs:/vault/certs:ro   # initiale Zertifikate von vault-1-seed
      - vault-1-data:/vault/raft
      - vault-1-logs:/vault/logs
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-1-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    pid: "service:vault-1"
    depends_on: [ vault-1 ]
    entrypoint: vault agent -config=/vault/agents/vault-1-agent.hcl
    environment:
      SKIP_SETCAP: "true"
    volumes:
      - vault-1-runtime-certs:/vault/certs:rw
      - vault-1-agent-role:/approle:rw
      - vault-1-agent-config:/vault/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
      - /run/vault:rw,size=4m,mode=0700,uid=100,gid=100
      - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-2:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    entrypoint: vault server -config=/vault/config/vault-2.hcl
    depends_on: [ vault-1 ]
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    environment:
      SKIP_SETCAP: "1"
      SKIP_CHOWN: "true"
    ports: [ "127.0.0.1:28200:8300" ] # Vault ui erreichbar unter https://localhost:28200
    volumes:
      - vault-2-config:/vault/config:ro
      - vault-2-runtime-certs:/vault/certs:ro
      - vault-2-data:/vault/raft
      - vault-2-logs:/vault/logs
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
  
  vault-2-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    pid: "service:vault-2"
    depends_on: [ vault-2 ]
    entrypoint: vault agent -config=/vault/agents/vault-2-agent.hcl
    environment:
      SKIP_SETCAP: "true"
    volumes:
      - vault-2-runtime-certs:/vault/certs:rw
      - vault-2-agent-role:/approle:rw
      - vault-2-agent-config:/vault/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
     - /run/vault:rw,size=4m,mode=0700,uid=100,gid=100
     - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped


  vault-3:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    entrypoint: vault server -config=/vault/config/vault-3.hcl
    cap_add: [ "IPC_LOCK" ]
    ulimits: { memlock: -1 }
    environment:
      SKIP_SETCAP: "1"
      SKIP_CHOWN: "true"
    ports: [ "127.0.0.1:38200:8300" ] # Vault ui erreichbar unter https://localhost:38200
    volumes:
      - vault-3-config:/vault/config:ro
      - vault-3-runtime-certs:/vault/certs:ro
      - vault-3-data:/vault/raft
      - vault-3-logs:/vault/logs
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  vault-3-agent:
    profiles: [ "prod" ]
    image: hashicorp/vault:1.20
    user: "100:100"
    pid: "service:vault-3"
    depends_on: [ vault-3 ]
    entrypoint: vault agent -config=/vault/agents/vault-3-agent.hcl
    environment:
      SKIP_SETCAP: "true"
    volumes:
      - vault-3-runtime-certs:/vault/certs:rw
      - vault-3-agent-role:/approle:rw
      - vault-3-agent-config:/vault/agents:ro
      - vault-agent-hup:/agent/hup:ro
    tmpfs:
     - /run/vault:rw,size=4m,mode=0700,uid=100,gid=100
     - /tmp:rw,size=8m,mode=1777
    read_only: true
    networks: [ api-network ]
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
networks:
  api-network:
    driver: bridge

volumes:

# SERVICES
  database: {}
  web-application-firewall-certs: {}
  game-service-certs: {}
  cli-certs: {}
  service-agent-config: {}
  web-application-firewall-agent-certs: {}
  web-application-firewall-agent-approle: {}
  api-gateway-service-certs: {}
  api-gateway-agent-certs: {}
  api-gateway-agent-approle: {}
  api-gateway-approle-service: {}
  game-service-agent-certs: {}
  game-service-agent-approle: {}
  auth-user-service-agent-certs: {}
  auth-user-service-certs: {}
  auth-user-service-agent-approle: {}
  auth-user-service-approle: {}
  ai-opponent-agent-approle: {}
  ai-opponent-certs: {}
  ai-opponent-agent-certs: {}
  ai-opponent-model: {}
  avatar-uploads: {}
  database-upload: {}
# VAULT
  vault-dev-config: {}
  vault-dev-data: {}
  vault-dev-logs: {}
  vault-dev-runtime-certs: {}

  vault-1-config: {}
  vault-1-data: {}
  vault-1-logs: {}
  vault-1-runtime-certs: {}

  vault-2-config: {}
  vault-2-data: {}
  vault-2-logs: {}
  vault-2-runtime-certs: {}

  vault-3-config: {}
  vault-3-data: {}
  vault-3-logs: {}
  vault-3-runtime-certs: {}

  vault-1-agent-config: {}
  vault-1-agent-role: {}
  vault-2-agent-config: {}
  vault-2-agent-role: {}
  vault-3-agent-config: {}
  vault-3-agent-role: {}
  vault-keys: {}
  agent-server-config: {}
  agent-server-client-config: {}

  vault-agent-hup: {}
