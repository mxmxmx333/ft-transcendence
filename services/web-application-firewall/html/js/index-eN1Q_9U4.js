(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class et{constructor(e,t){this.isSinglePlayer=!1,this.isRemote=!1,this.lastTimeStamp=0,this.gameRunning=!1,this.isPlayer1=!1,this.roomId=null,this.opponentNickname="",this.myNickname="Player",this.paddleHeight=100,this.paddleWidth=15,this.ballRadius=10,this.winningScore=10,this.playerY=250,this.opponentY=250,this.ballX=400,this.ballY=300,this.playerScore=0,this.opponentScore=0,this.isPaused=!1,this.upPressed=!1,this.downPressed=!1,this.wPressed=!1,this.sPressed=!1,this.isDragging=!1,this.touchStartY=0,this.touchCurrentY=0,this.canvasSizeRatio=1,this.canvasSizeRatioX=1,this.canvasSizeRatioY=1,this.lastPaddleUpdate=0,this.paddleUpdateInterval=50,this.gameLoop=n=>{console.debug(`Game loop running: ${this.gameRunning}`),this.gameRunning&&(n-this.lastPaddleUpdate>=this.paddleUpdateInterval&&(this.lastPaddleUpdate=n,this.handlePaddleMovement()),this.isPaused||n-this.lastPaddleUpdate>=this.paddleUpdateInterval&&(this.lastPaddleUpdate=n,this.handlePaddleMovement()),this.gameRunning&&requestAnimationFrame(this.gameLoop))},console.log("Initializing Pong Game"),this.socketManager=t,this.canvas=e,this.ctx=e.getContext("2d"),this.init()}async init(){this.setupCanvas(),this.setupControls(),this.setupMobileControls(),this.setupSocketListeners(),this.setupGameControls()}setupSocketListeners(){const e=this.socketManager?.getSocket();e&&(console.log("Setting up socket listeners"),e.on("game_pause_state",t=>{console.log("Game pause state:",t),t?this.pauseGame():this.resume()}))}setupCanvas(){const e=1.7777777777777777,t=800,n=600,i=this.canvas.parentElement,r=i?.clientWidth||t,a=i?.clientHeight||n;let c=Math.min(r,t),l=c/e;l>a&&(l=a,c=l*e),this.canvas.width=c,this.canvas.height=l,this.canvas.style.width=`${c}px`,this.canvas.style.height=`${l}px`,this.canvasSizeRatioX=this.canvas.width/t,this.canvasSizeRatioY=this.canvas.height/n,this.canvasSizeRatio=Math.min(this.canvasSizeRatioX,this.canvasSizeRatioY),this.paddleHeight=100*this.canvasSizeRatioY,this.paddleWidth=15*this.canvasSizeRatioX,this.ballRadius=10*this.canvasSizeRatio,window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){this.setupCanvas()}setupControls(){const e=n=>{n.key==="w"||n.key==="W"?this.wPressed=!0:(n.key==="s"||n.key==="S")&&(this.sPressed=!0),n.key==="ArrowUp"?this.upPressed=!0:n.key==="ArrowDown"&&(this.downPressed=!0)},t=n=>{(n.key==="w"||n.key==="W")&&(this.wPressed=!1),(n.key==="s"||n.key==="S")&&(this.sPressed=!1),n.key==="ArrowUp"&&(this.upPressed=!1),n.key==="ArrowDown"&&(this.downPressed=!1)};document.addEventListener("keydown",e),document.addEventListener("keyup",t)}returnToNewGamePage(){v(wt)}setupMobileControls(){this.canvas.addEventListener("touchstart",e=>{e.preventDefault(),this.isDragging=!0,this.touchStartY=e.touches[0].clientY,this.touchCurrentY=this.touchStartY}),this.canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),!this.isDragging)return;this.touchCurrentY=e.touches[0].clientY;const t=this.touchCurrentY-this.touchStartY;Math.abs(t)>5&&(t<0?this.isPlayer1?this.wPressed=!0:this.upPressed=!0:this.isPlayer1?this.sPressed=!0:this.downPressed=!0)}),this.canvas.addEventListener("touchend",e=>{e.preventDefault(),this.isDragging=!1,this.wPressed=!1,this.sPressed=!1,this.upPressed=!1,this.downPressed=!1})}setupGameControls(){const e=document.getElementById("start-btn"),t=document.getElementById("pause-btn");e&&e.addEventListener("click",()=>this.startGame()),t&&t.addEventListener("click",()=>this.pauseGame())}async setupUI(){try{const e=await fetch("/api/profile",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(e.ok){const t=await e.json();this.myNickname=t.nickname,!this.isRemote&&!this.isSinglePlayer&&(this.myNickname="Player1"),document.getElementById("game-nick").textContent=this.myNickname}}catch(e){console.error("Failed to fetch user profile:",e),document.getElementById("game-nick").textContent="Player"}}updateStatus(e){console.log(`[Status] ${e}`);let t=document.getElementById("game-status");if(!t){const n=document.querySelector(".game-page");if(n)t=document.createElement("div"),t.id="game-status",t.style.cssText=`
          position: absolute; 
          top: 10px; 
          left: 50%; 
          transform: translateX(-50%); 
          color: white; 
          font-size: 18px; 
          font-weight: bold; 
          z-index: 100;
          background: rgba(0,0,0,0.7);
          padding: 10px 20px;
          border-radius: 5px;
        `,n.appendChild(t),console.log("Status element created");else{console.warn("No game area found to create status element");return}}t.textContent=e}updateFromServer(e){this.ballX=e.ballX*this.canvasSizeRatioX,this.ballY=e.ballY*this.canvasSizeRatioY,this.isPlayer1?(this.playerY=e.paddle1Y*this.canvasSizeRatioY,this.opponentY=e.paddle2Y*this.canvasSizeRatioY,this.playerScore=e.ownerScore,this.opponentScore=e.guestScore):(this.playerY=e.paddle2Y*this.canvasSizeRatioY,this.opponentY=e.paddle1Y*this.canvasSizeRatioY,this.playerScore=e.guestScore,this.opponentScore=e.ownerScore),console.debug(`game_state received: ${e}`),this.draw()}handleGameStart(e){if(console.log("Game start received:",e),console.log("Canvas element:",this.canvas),console.log("Is Owner:",e.isOwner),console.log("Owner info:",e.owner),console.log("Guest info:",e.guest),console.log("Message.owner.nickname:",e.owner.nickname),console.log("Message.guest.nickname:",e.guest.nickname),this.countdownInterval){console.log("Countdown already running, ignoring duplicate game start");return}this.gameRunning&&(console.log("Game already running, stopping first"),this.stop());const t=this.socketManager?.getSocket();if(console.debug("Socket listeners:",t?.listeners("game_state")),console.debug("Socket connected:",t?.connected),this.gameRunning&&this.stop(),this.gameRunning=!1,!this.canvas||!this.ctx){console.error("Canvas or context not available for game start");return}this.canvas.style.display="block",this.canvas.style.visibility="visible",console.log("Canvas visibility set to visible"),this.isPlayer1=e.isOwner,this.roomId=e.roomId,e.isOwner?(this.myNickname=e.owner.nickname,this.opponentNickname=e.guest.nickname):(this.myNickname=e.guest.nickname,this.opponentNickname=e.owner.nickname),document.getElementById("game-nick").textContent=e.owner.nickname,document.getElementById("game-nick2").textContent=e.guest.nickname,console.log(`I am ${this.isPlayer1?"Player 1 (Owner)":"Player 2 (Guest)"}`),console.log(`My nickname: ${this.myNickname}`),console.log(`Opponent nickname: ${this.opponentNickname}`),console.log("Owner nickname (left):",e.owner.nickname),console.log("Guest nickname (right):",e.guest.nickname),this.updateStatus(`You are playing on the ${this.isPlayer1?"left with W/S keys":"right with arrow keys"}. Game starting!`),v(U),this.startCountdown()}startCountdown(){if(this.countdownInterval){console.log("Countdown already active");return}let e=3;this.announce_match(this.myNickname,this.opponentNickname),this.countdownInterval&&clearInterval(this.countdownInterval),this.countdownInterval=setInterval(()=>{e--,e>0?this.updateStatus(`Game starting in ${e} seconds...`):(this.updateStatus("Game started! Good luck!"),clearInterval(this.countdownInterval),this.countdownInterval=void 0,this.gameRunning?console.log("Game already running, skipping start"):(console.log("Starting game after countdown"),this.start()))},1e3)}announce_match(e,t){this.updateStatus(`Next Match: ${e} vs ${t}`),console.log("Tournament match announcement:",{owner:e,guest:t})}handleRoomTerminated(){console.warn("Room terminated, returning to lobby"),this.stop(),this.returnToNewGamePage(),alert("Room was terminated by server")}handleGameOver(e){this.gameRunning=!1,console.log("Game over message:",e),console.log("Game over. Winner:",e.winner),console.log(`myNickname = ${this.myNickname}, opponentNick = ${this.opponentNickname}`),this.drawGameOver(e.winner)}matchEnd(e){this.gameRunning=!1,console.log("Match end message:",e),console.log("Winner:",e.winnerName),this.drawMatchOver(e.winnerName)}handleOpponentDisconnected(){this.updateStatus("Opponent disconnected"),setTimeout(()=>{this.gameRunning=!1,this.updateStatus("Game ended due to opponent disconnect"),this.returnToNewGamePage()},2e3)}handleConnectionLost(){this.gameRunning=!1,this.updateStatus("Connection lost. Trying to reconnect...")}draw(){if(!this.gameRunning)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle="#ffff00",this.ctx.setLineDash([10,10]),this.ctx.beginPath(),this.ctx.moveTo(this.canvas.width/2,0),this.ctx.lineTo(this.canvas.width/2,this.canvas.height),this.ctx.stroke(),this.ctx.setLineDash([]);const e=8*this.canvasSizeRatio;this.ctx.fillStyle=this.isPlayer1?"#ff00ff":"#00ffff";const t=this.isPlayer1?10*this.canvasSizeRatioX:this.canvas.width-25*this.canvasSizeRatioX;this.drawRoundedRect(t,this.playerY,this.paddleWidth,this.paddleHeight,e),this.ctx.fillStyle=this.isPlayer1?"#00ffff":"#ff00ff";const n=this.isPlayer1?this.canvas.width-25*this.canvasSizeRatioX:10*this.canvasSizeRatioX;this.drawRoundedRect(n,this.opponentY,this.paddleWidth,this.paddleHeight,e),this.ctx.fillStyle="#ffff00",this.ctx.beginPath(),this.ctx.arc(this.ballX,this.ballY,this.ballRadius,0,Math.PI*2),this.ctx.fill(),this.isPlayer1?(document.getElementById("score").textContent=this.playerScore.toString(),document.getElementById("score2").textContent=this.opponentScore.toString()):(document.getElementById("score").textContent=this.opponentScore.toString(),document.getElementById("score2").textContent=this.playerScore.toString())}handlePaddleMovement(){if(console.debug("Handling paddle movement"),this.isPaused)return;let e="none",t="none";this.wPressed&&!this.sPressed?e="up":this.sPressed&&!this.wPressed?e="down":e="none",this.upPressed&&!this.downPressed?t="up":this.downPressed&&!this.upPressed?t="down":t="none";let n={moveP1:e,moveP2:t};this.socketManager?.paddleMove(n)}drawRoundedRect(e,t,n,i,r){this.ctx.beginPath(),this.ctx.moveTo(e+r,t),this.ctx.lineTo(e+n-r,t),this.ctx.quadraticCurveTo(e+n,t,e+n,t+r),this.ctx.lineTo(e+n,t+i-r),this.ctx.quadraticCurveTo(e+n,t+i,e+n-r,t+i),this.ctx.lineTo(e+r,t+i),this.ctx.quadraticCurveTo(e,t+i,e,t+i-r),this.ctx.lineTo(e,t+r),this.ctx.quadraticCurveTo(e,t,e+r,t),this.ctx.closePath(),this.ctx.fill()}drawGameOver(e){this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 48px Arial",this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",this.canvas.width/2,this.canvas.height/2-50),this.ctx.font="bold 36px Arial",this.ctx.fillText(`${e} WON!`,this.canvas.width/2,this.canvas.height/2+20),this.ctx.font="24px Arial",this.ctx.fillText("Game will return to lobby in 5 seconds",this.canvas.width/2,this.canvas.height/2+80),setTimeout(()=>{this.resetGame(),this.returnToNewGamePage()},5e3)}drawMatchOver(e){this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 48px Arial",this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",this.canvas.width/2,this.canvas.height/2-50),this.ctx.font="bold 36px Arial",this.ctx.fillText(`${e} WON!`,this.canvas.width/2,this.canvas.height/2+20),this.ctx.font="24px Arial",this.ctx.fillText("Next Match will start in 5 seconds",this.canvas.width/2,this.canvas.height/2+80)}resetGame(){this.playerScore=0,this.opponentScore=0,this.playerY=250,this.opponentY=250,this.ballX=400,this.ballY=300,document.getElementById("score").textContent="0",document.getElementById("score2").textContent="0"}start(){if(this.gameRunning){console.warn("Game is already running");return}this.gameRunning=!0,this.lastTimeStamp=performance.now(),this.lastPaddleUpdate=performance.now(),this.animationId=requestAnimationFrame(this.gameLoop),console.log("Game started")}startGame(){if(this.gameRunning&&!this.isPaused){console.warn("Game is already running");return}this.isPaused?this.resume():this.start()}pauseGame(){!this.gameRunning||this.isPaused||(this.isPaused=!0,this.gameRunning=!1,this.animationId&&cancelAnimationFrame(this.animationId),this.updateStatus("Game paused"),this.socketManager?.setGamePauseState(!0))}resume(){this.isPaused&&(this.isPaused=!1,this.gameRunning=!0,this.lastTimeStamp=performance.now(),this.animationId=requestAnimationFrame(this.gameLoop),this.updateStatus("Game resumed"),this.socketManager?.setGamePauseState(!1))}stop(){this.gameRunning=!1,this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=void 0,console.log("Countdown stopped")),this.animationId&&cancelAnimationFrame(this.animationId)}}const P=Object.create(null);P.open="0";P.close="1";P.ping="2";P.pong="3";P.message="4";P.upgrade="5";P.noop="6";const ee=Object.create(null);Object.keys(P).forEach(s=>{ee[P[s]]=s});const ve={type:"error",data:"parser error"},tt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",nt=typeof ArrayBuffer=="function",st=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,Te=({type:s,data:e},t,n)=>tt&&e instanceof Blob?t?n(e):ze(e,n):nt&&(e instanceof ArrayBuffer||st(e))?t?n(e):ze(new Blob([e]),n):n(P[s]+(e||"")),ze=(s,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(s)};function je(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let ue;function Pt(s,e){if(tt&&s.data instanceof Blob)return s.data.arrayBuffer().then(je).then(e);if(nt&&(s.data instanceof ArrayBuffer||st(s.data)))return e(je(s.data));Te(s,!1,t=>{ue||(ue=new TextEncoder),e(ue.encode(t))})}const Ve="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",V=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<Ve.length;s++)V[Ve.charCodeAt(s)]=s;const Rt=s=>{let e=s.length*.75,t=s.length,n,i=0,r,a,c,l;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const m=new ArrayBuffer(e),p=new Uint8Array(m);for(n=0;n<t;n+=4)r=V[s.charCodeAt(n)],a=V[s.charCodeAt(n+1)],c=V[s.charCodeAt(n+2)],l=V[s.charCodeAt(n+3)],p[i++]=r<<2|a>>4,p[i++]=(a&15)<<4|c>>2,p[i++]=(c&3)<<6|l&63;return m},Mt=typeof ArrayBuffer=="function",_e=(s,e)=>{if(typeof s!="string")return{type:"message",data:ot(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:qt(s.substring(1),e)}:ee[t]?s.length>1?{type:ee[t],data:s.substring(1)}:{type:ee[t]}:ve},qt=(s,e)=>{if(Mt){const t=Rt(s);return ot(t,e)}else return{base64:!0,data:s}},ot=(s,e)=>{switch(e){case"blob":return s instanceof Blob?s:new Blob([s]);case"arraybuffer":default:return s instanceof ArrayBuffer?s:s.buffer}},it="",Nt=(s,e)=>{const t=s.length,n=new Array(t);let i=0;s.forEach((r,a)=>{Te(r,!1,c=>{n[a]=c,++i===t&&e(n.join(it))})})},Ot=(s,e)=>{const t=s.split(it),n=[];for(let i=0;i<t.length;i++){const r=_e(t[i],e);if(n.push(r),r.type==="error")break}return n};function Ft(){return new TransformStream({transform(s,e){Pt(s,t=>{const n=t.length;let i;if(n<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,n);else if(n<65536){i=new Uint8Array(3);const r=new DataView(i.buffer);r.setUint8(0,126),r.setUint16(1,n)}else{i=new Uint8Array(9);const r=new DataView(i.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(n))}s.data&&typeof s.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(t)})}})}let me;function Q(s){return s.reduce((e,t)=>e+t.length,0)}function Z(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let n=0;for(let i=0;i<e;i++)t[i]=s[0][n++],n===s[0].length&&(s.shift(),n=0);return s.length&&n<s[0].length&&(s[0]=s[0].slice(n)),t}function Dt(s,e){me||(me=new TextDecoder);const t=[];let n=0,i=-1,r=!1;return new TransformStream({transform(a,c){for(t.push(a);;){if(n===0){if(Q(t)<1)break;const l=Z(t,1);r=(l[0]&128)===128,i=l[0]&127,i<126?n=3:i===126?n=1:n=2}else if(n===1){if(Q(t)<2)break;const l=Z(t,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),n=3}else if(n===2){if(Q(t)<8)break;const l=Z(t,8),m=new DataView(l.buffer,l.byteOffset,l.length),p=m.getUint32(0);if(p>Math.pow(2,21)-1){c.enqueue(ve);break}i=p*Math.pow(2,32)+m.getUint32(4),n=3}else{if(Q(t)<i)break;const l=Z(t,i);c.enqueue(_e(r?l:me.decode(l),e)),n=0}if(i===0||i>s){c.enqueue(ve);break}}}})}const rt=4;function w(s){if(s)return Ht(s)}function Ht(s){for(var e in w.prototype)s[e]=w.prototype[e];return s}w.prototype.on=w.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};w.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};w.prototype.off=w.prototype.removeListener=w.prototype.removeAllListeners=w.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var n,i=0;i<t.length;i++)if(n=t[i],n===e||n.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+s],this};w.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,i=t.length;n<i;++n)t[n].apply(this,e)}return this};w.prototype.emitReserved=w.prototype.emit;w.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};w.prototype.hasListeners=function(s){return!!this.listeners(s).length};const ce=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),x=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),$t="arraybuffer";function at(s,...e){return e.reduce((t,n)=>(s.hasOwnProperty(n)&&(t[n]=s[n]),t),{})}const Ut=x.setTimeout,Gt=x.clearTimeout;function le(s,e){e.useNativeTimers?(s.setTimeoutFn=Ut.bind(x),s.clearTimeoutFn=Gt.bind(x)):(s.setTimeoutFn=x.setTimeout.bind(x),s.clearTimeoutFn=x.clearTimeout.bind(x))}const zt=1.33;function jt(s){return typeof s=="string"?Vt(s):Math.ceil((s.byteLength||s.size)*zt)}function Vt(s){let e=0,t=0;for(let n=0,i=s.length;n<i;n++)e=s.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}function ct(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Yt(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function Wt(s){let e={},t=s.split("&");for(let n=0,i=t.length;n<i;n++){let r=t[n].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class Jt extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class Ae extends w{constructor(e){super(),this.writable=!1,le(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new Jt(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=_e(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Yt(e);return t.length?"?"+t:""}}class Xt extends Ae{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let n=0;this._polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};Ot(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Nt(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=ct()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let lt=!1;try{lt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Kt=lt;function Qt(){}class Zt extends Xt{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let n=location.port;n||(n=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(i,r)=>{this.onError("xhr post error",i,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class _ extends w{constructor(e,t,n){super(),this.createRequest=e,le(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=n.data!==void 0?n.data:null,this._create()}_create(){var e;const t=at(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&n.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{n.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var i;n.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(n.getResponseHeader("set-cookie"))),n.readyState===4&&(n.status===200||n.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof n.status=="number"?n.status:0)},0))},n.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=_.requestsCount++,_.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Qt,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete _.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}_.requestsCount=0;_.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Ye);else if(typeof addEventListener=="function"){const s="onpagehide"in x?"pagehide":"unload";addEventListener(s,Ye,!1)}}function Ye(){for(let s in _.requests)_.requests.hasOwnProperty(s)&&_.requests[s].abort()}const en=function(){const s=dt({xdomain:!1});return s&&s.responseType!==null}();class tn extends Zt{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=en&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new _(dt,this.uri(),e)}}function dt(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Kt))return new XMLHttpRequest}catch{}if(!e)try{return new x[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const ht=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class nn extends Ae{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=ht?{}:at(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;Te(n,this.supportsBinary,r=>{try{this.doWrite(n,r)}catch{}i&&ce(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=ct()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const fe=x.WebSocket||x.MozWebSocket;class sn extends nn{createSocket(e,t,n){return ht?new fe(e,t,n):t?new fe(e,t):new fe(e)}doWrite(e,t){this.ws.send(t)}}class on extends Ae{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=Dt(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),i=Ft();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{n.read().then(({done:c,value:l})=>{c||(this.onPacket(l),r())}).catch(c=>{})};r();const a={type:"open"};this.query.sid&&(a.data=`{"sid":"${this.query.sid}"}`),this._writer.write(a).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;this._writer.write(n).then(()=>{i&&ce(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const rn={websocket:sn,webtransport:on,polling:tn},an=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,cn=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function we(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),n=s.indexOf("]");t!=-1&&n!=-1&&(s=s.substring(0,t)+s.substring(t,n).replace(/:/g,";")+s.substring(n,s.length));let i=an.exec(s||""),r={},a=14;for(;a--;)r[cn[a]]=i[a]||"";return t!=-1&&n!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=ln(r,r.path),r.queryKey=dn(r,r.query),r}function ln(s,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function dn(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,i,r){i&&(t[i]=r)}),t}const ke=typeof addEventListener=="function"&&typeof removeEventListener=="function",te=[];ke&&addEventListener("offline",()=>{te.forEach(s=>s())},!1);class q extends w{constructor(e,t){if(super(),this.binaryType=$t,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const n=we(e);t.hostname=n.host,t.secure=n.protocol==="https"||n.protocol==="wss",t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=we(t.host).host);le(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(n=>{const i=n.prototype.name;this.transports.push(i),this._transportsByName[i]=n}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Wt(this.opts.query)),ke&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},te.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=rt,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&q.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",q.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const i=this.writeBuffer[n].data;if(i&&(t+=jt(i)),n>0&&t>this._maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,ce(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,i){if(typeof t=="function"&&(i=t,t=void 0),typeof n=="function"&&(i=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const r={type:e,data:t,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}_onError(e){if(q.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),ke&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const n=te.indexOf(this._offlineEventListener);n!==-1&&te.splice(n,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}q.protocol=rt;class hn extends q{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;q.priorWebsocketSuccess=!1;const i=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",b=>{if(!n)if(b.type==="pong"&&b.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;q.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(p(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const L=new Error("probe error");L.transport=t.name,this.emitReserved("upgradeError",L)}}))};function r(){n||(n=!0,p(),t.close(),t=null)}const a=b=>{const L=new Error("probe error: "+b);L.transport=t.name,r(),this.emitReserved("upgradeError",L)};function c(){a("transport closed")}function l(){a("socket closed")}function m(b){t&&b.name!==t.name&&r()}const p=()=>{t.removeListener("open",i),t.removeListener("error",a),t.removeListener("close",c),this.off("close",l),this.off("upgrading",m)};t.once("open",i),t.once("error",a),t.once("close",c),this.once("close",l),this.once("upgrading",m),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{n||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}let un=class extends hn{constructor(e,t={}){const n=typeof e=="object"?e:t;(!n.transports||n.transports&&typeof n.transports[0]=="string")&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map(i=>rn[i]).filter(i=>!!i)),super(e,n)}};function mn(s,e="",t){let n=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),n=we(s)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const r=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port+e,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n}const fn=typeof ArrayBuffer=="function",pn=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,ut=Object.prototype.toString,gn=typeof Blob=="function"||typeof Blob<"u"&&ut.call(Blob)==="[object BlobConstructor]",yn=typeof File=="function"||typeof File<"u"&&ut.call(File)==="[object FileConstructor]";function Pe(s){return fn&&(s instanceof ArrayBuffer||pn(s))||gn&&s instanceof Blob||yn&&s instanceof File}function ne(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,n=s.length;t<n;t++)if(ne(s[t]))return!0;return!1}if(Pe(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return ne(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&ne(s[t]))return!0;return!1}function vn(s){const e=[],t=s.data,n=s;return n.data=be(t,e),n.attachments=e.length,{packet:n,buffers:e}}function be(s,e){if(!s)return s;if(Pe(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let n=0;n<s.length;n++)t[n]=be(s[n],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=be(s[n],e));return t}return s}function wn(s,e){return s.data=Le(s.data,e),delete s.attachments,s}function Le(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=Le(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=Le(s[t],e));return s}const kn=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],bn=5;var u;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(u||(u={}));class Ln{constructor(e){this.replacer=e}encode(e){return(e.type===u.EVENT||e.type===u.ACK)&&ne(e)?this.encodeAsBinary({type:e.type===u.EVENT?u.BINARY_EVENT:u.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===u.BINARY_EVENT||e.type===u.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=vn(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}}function We(s){return Object.prototype.toString.call(s)==="[object Object]"}class Re extends w{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===u.BINARY_EVENT;n||t.type===u.BINARY_ACK?(t.type=n?u.EVENT:u.ACK,this.reconstructor=new En(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Pe(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(u[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===u.BINARY_EVENT||n.type===u.BINARY_ACK){const r=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const a=e.substring(r,t);if(a!=Number(a)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(a)}if(e.charAt(t+1)==="/"){const r=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(r,t)}else n.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const r=t+1;for(;++t;){const a=e.charAt(t);if(a==null||Number(a)!=a){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(Re.isPayloadValid(n.type,r))n.data=r;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case u.CONNECT:return We(t);case u.DISCONNECT:return t===void 0;case u.CONNECT_ERROR:return typeof t=="string"||We(t);case u.EVENT:case u.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&kn.indexOf(t[0])===-1);case u.ACK:case u.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class En{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=wn(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Sn=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Re,Encoder:Ln,get PacketType(){return u},protocol:bn},Symbol.toStringTag,{value:"Module"}));function B(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const xn=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class mt extends w{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[B(e,"open",this.onopen.bind(this)),B(e,"packet",this.onpacket.bind(this)),B(e,"error",this.onerror.bind(this)),B(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,i,r;if(xn.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const a={type:u.EVENT,data:t};if(a.options={},a.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const p=this.ids++,b=t.pop();this._registerAckCallback(p,b),a.id=p}const c=(i=(n=this.io.engine)===null||n===void 0?void 0:n.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!c||(l?(this.notifyOutgoingListeners(a),this.packet(a)):this.sendBuffer.push(a)),this.flags={},this}_registerAckCallback(e,t){var n;const i=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);t.call(this,new Error("operation has timed out"))},i),a=(...c)=>{this.io.clearTimeoutFn(r),t.apply(this,c)};a.withError=!0,this.acks[e]=a}emitWithAck(e,...t){return new Promise((n,i)=>{const r=(a,c)=>a?i(a):n(c);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...r)=>n!==this._queue[0]?void 0:(i!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...r)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:u.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(n=>String(n.id)===e)){const n=this.acks[e];delete this.acks[e],n.withError&&n.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case u.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case u.EVENT:case u.BINARY_EVENT:this.onevent(e);break;case u.ACK:case u.BINARY_ACK:this.onack(e);break;case u.DISCONNECT:this.ondisconnect();break;case u.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...i){n||(n=!0,t.packet({type:u.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:u.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function G(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}G.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=(Math.floor(e*10)&1)==0?s-t:s+t}return Math.min(s,this.max)|0};G.prototype.reset=function(){this.attempts=0};G.prototype.setMin=function(s){this.ms=s};G.prototype.setMax=function(s){this.max=s};G.prototype.setJitter=function(s){this.jitter=s};class Ee extends w{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,le(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new G({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||Sn;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new un(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=B(t,"open",function(){n.onopen(),e&&e()}),r=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},a=B(t,"error",r);if(this._timeout!==!1){const c=this._timeout,l=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),t.close()},c);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(a),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(B(e,"ping",this.onping.bind(this)),B(e,"data",this.ondata.bind(this)),B(e,"error",this.onerror.bind(this)),B(e,"close",this.onclose.bind(this)),B(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){ce(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new mt(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),(n=this.engine)===null||n===void 0||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const j={};function Y(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=mn(s,e.path||"/socket.io"),n=t.source,i=t.id,r=t.path,a=j[i]&&r in j[i].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||a;let l;return c?l=new Ee(n,e):(j[i]||(j[i]=new Ee(n,e)),l=j[i]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(Y,{Manager:Ee,Socket:mt,io:Y,connect:Y});class R{constructor(){this.gameInstance=null,this.isConnecting=!1,this.connectionPromise=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.roomOperationTimeout=1e4,this.onGameStart=null}static getInstance(){return R.instance||(console.log("Creating new SocketManager instance"),R.instance=new R),R.instance}hasActiveConnection(){return this.socket?.connected??!1}async ensureConnection(){if(this.hasActiveConnection())return console.log("Socket already connected"),Promise.resolve();if(this.isConnecting&&this.connectionPromise)return console.log("Connection already in progress"),this.connectionPromise;this.isConnecting=!0,this.connectionPromise=this.performConnection();try{await this.connectionPromise}finally{this.isConnecting=!1,this.connectionPromise=null}}async setGamePauseState(e){this.hasActiveConnection()&&(this.socket.emit("game_pause",e),console.log(`[Client] game_pause emitted: ${e}`))}performConnection(){return new Promise((e,t)=>{const n=localStorage.getItem("authToken");if(!n)return t(new Error("No authentication token found"));this.socket&&(this.socket.disconnect(),this.socket=void 0),this.socket=this.createSocket(n),this.setupConnectionListeners(e,t),this.setupGameEventListeners(),this.setupRoomEventListeners()})}createSocket(e){return Y({path:"/socket.io",auth:{token:e},query:{token:e},transports:["websocket","polling"],reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay,secure:!0,rejectUnauthorized:!1,withCredentials:!0,upgrade:!0,rememberUpgrade:!0})}setupConnectionListeners(e,t){this.socket&&(this.socket.on("connect",()=>{console.log("Socket connected:",this.socket?.id),this.reconnectAttempts=0,e()}),this.socket.on("connect_error",n=>{console.error("Connection error:",n),t(n)}),this.socket.on("disconnect",()=>{console.warn("Socket disconnected"),this.handleReconnection()}),this.socket.on("error",n=>{console.error("Socket error:",n)}),this.setupTournamentEventListeners())}setupGameEventListeners(){this.socket&&(this.socket.on("game_start",e=>{console.log("Game start received:",e),console.debug("[Game] this.gameInstance:",this.gameInstance),this.gameInstance?.handleGameStart(e),this.onGameStart?.(e)}),this.socket.on("game_over",e=>{console.log("Game over:",e),this.gameInstance?.handleGameOver({...e})}),this.socket.on("game_aborted",e=>{console.log("Game aborted:",e),this.gameInstance?.handleRoomTerminated()}),this.socket.on("game_state",e=>{this.gameInstance?.updateFromServer(e)}))}setupRoomEventListeners(){this.socket&&(this.socket.on("joined_room",e=>{console.log("Joined room:",e)}),this.socket.on("room_created",e=>{console.log("Room created:",e),this.updateLobbyStatus(`Room created: ${e.roomId}. Waiting for opponent...`)}),this.socket.on("join_error",e=>{console.error("Join error:",e.message),alert(`Join error: ${e.message}`)}),this.socket.on("create_error",e=>{console.error("Create error:",e.message),alert(`Create error: ${e.message}`)}),this.socket.on("room_error",e=>{console.log("Room error:",e.message),alert(`Room error: ${e.message}`)}))}setupTournamentEventListeners(){this.socket&&(this.socket.on("tournament_room_created",e=>{console.log("Tournament room created:",e)}),this.socket.on("joined_tournament_room",e=>{console.log("Joined tournament room:",e)}),this.socket.on("tournament_players_updated",e=>{console.log("Tournament players updated:",e),ie(e.players)}),this.socket.on("tournament_error",e=>{console.error("Tournament error:",e),alert(`Tournament error: ${e.message}`)}),this.socket.on("tournament_player_joined",e=>{console.log("Player joined tournament:",e),window.updateTournamentPlayers&&window.updateTournamentPlayers(e.players||e.room?.players||[])}),this.socket.on("tournament_player_left",e=>{console.log("Player left tournament:",e),window.updateTournamentPlayers&&window.updateTournamentPlayers(e.players||e.room?.players||[])}),this.socket.on("tournament_match_start",e=>{console.log("Current game instance:",this.gameInstance),this.gameInstance&&(console.log(" Stopping previous game instance"),this.gameInstance.stop(),this.gameInstance=null),window.location.hash.includes("#/pong")||(console.log(" Navigating to game page for tournament match"),window.location.hash="#/pong"),Ho(e)}),this.socket.on("tournament_match_end",e=>{console.log("Tournament match ended:",e),this.gameInstance?.matchEnd(e)}),this.socket.on("tournament_winner",e=>{console.log("Tournament winner:",e),$o(e)}))}updateLobbyStatus(e){const t=document.getElementById("lobby-status");t&&(t.textContent=e)}handleReconnection(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.warn(`Reconnecting... Attempt ${this.reconnectAttempts}`),setTimeout(()=>{this.socket?.connect()},this.reconnectDelay)):(console.error("Max reconnection attempts reached. Please refresh the page."),this.gameInstance?.handleConnectionLost())}async createTournament(){if(await this.ensureConnection(),this.gameInstance&&this.gameInstance.gameRunning)throw new Error("Cannot create room while another game exists");return new Promise((e,t)=>{if(!this.hasActiveConnection())return t(new Error("Socket not connected"));const n=l=>{clearTimeout(c),a(),e(l)},i=l=>{clearTimeout(c),a(),t(new Error(l.message))},r=l=>{clearTimeout(c),a(),t(new Error(l.message||"Tournament error"))},a=()=>{this.socket.off("tournament_room_created",n),this.socket.off("create_error",i),this.socket.off("room_error",r)};this.socket.once("tournament_room_created",n),this.socket.once("create_error",i),this.socket.once("room_error",r);const c=setTimeout(()=>{a(),t(new Error("Tournament creation timeout"))},this.roomOperationTimeout);this.socket.emit("create_tournament_room"),console.log("[Client] create_tournament_room emitted")})}async joinTournament(e){if(await this.ensureConnection(),this.gameInstance&&this.gameInstance.gameRunning)throw new Error("Cannot join tournament while another game exists");return new Promise((t,n)=>{if(!this.hasActiveConnection())return n(new Error("Socket not connected"));const i=m=>{clearTimeout(l),c(),t(m)},r=m=>{clearTimeout(l),c(),n(new Error(m.message))},a=m=>{clearTimeout(l),c(),n(new Error(m.message||"Tournament error"))},c=()=>{this.socket.off("joined_tournament_room",i),this.socket.off("join_error",r),this.socket.off("tournament_error",a)};this.socket.once("joined_tournament_room",i),this.socket.once("join_error",r),this.socket.once("tournament_error",a);const l=setTimeout(()=>{c(),n(new Error("Join tournament timeout"))},this.roomOperationTimeout);this.socket.emit("join_tournament_room",{roomId:e}),console.log("[Client] join_tournament emitted for room:",e)})}async startTournament(e){await this.ensureConnection(),this.socket.emit("start_tournament",{roomId:e}),console.log("[Client] start_tournament emitted for tournament:",e)}async leaveTournament(){if(this.hasActiveConnection()){const e=document.getElementById("current-tournament-id")?.textContent;e&&e!=="-"&&(this.socket.emit("leave_tournament",{roomId:e}),console.log("[Client] leave_tournament emitted for:",e))}}async createRoom(){if(await this.ensureConnection(),this.gameInstance&&this.gameInstance.gameRunning)throw new Error("Cannot create room while another game exists");return new Promise((e,t)=>{if(!this.hasActiveConnection())return t(new Error("Socket not connected"));const n=l=>{clearTimeout(a),r(),e(l.roomId)},i=l=>{clearTimeout(a),r(),t(new Error(l.message))},r=()=>{this.socket.off("room_created",n),this.socket.off("create_error",i)};this.socket.once("room_created",n),this.socket.once("create_error",i);const a=setTimeout(()=>{r(),t(new Error("Room creation timeout"))},this.roomOperationTimeout),c={isSinglePlayer:this.gameInstance?.isSinglePlayer??!1,isRemote:this.gameInstance?.isRemote??!1};this.socket.emit("create_room",c),console.log("[Client] create_room emitted")})}async joinRoom(e){if(await this.ensureConnection(),this.gameInstance&&this.gameInstance.gameRunning)throw new Error("Cannot join room while another game exists");return new Promise((t,n)=>{if(!this.hasActiveConnection())return n(new Error("Socket not connected"));const i=l=>{clearTimeout(c),a(),t(l.roomId)},r=l=>{clearTimeout(c),a(),n(new Error(l.message))},a=()=>{this.socket.off("joined_room",i),this.socket.off("join_error",r)};this.socket.once("joined_room",i),this.socket.once("join_error",r);const c=setTimeout(()=>{a(),n(new Error("Join room timeout"))},this.roomOperationTimeout);this.socket.emit("join_room",{roomId:e}),console.log("[Client] join_room emitted for room:",e)})}async leaveRoom(){this.hasActiveConnection()&&(this.socket.emit("leave_room"),console.log("[Client] leave_room emitted"))}async paddleMove(e){this.hasActiveConnection()?this.socket.emit("paddle_move",e):console.warn("Cannot send paddle move: no active connection")}setGameInstance(e){console.log("Setting game instance"),this.gameInstance=e}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=void 0,console.log("Socket disconnected")),this.isConnecting=!1,this.connectionPromise=null}isConnected(){return this.hasActiveConnection()}getSocket(){return this.socket}getSocketId(){return this.socket?.id}getGameInstance(){return this.gameInstance}}class ft{constructor(){this.currentAvatar="default",this.initEventListeners()}init(){this.loadAvatars(),this.loadProfileData()}initEventListeners(){document.getElementById("options-btn")?.addEventListener("click",()=>{h("/options")}),document.getElementById("back-to-profile")?.addEventListener("click",()=>{h("/profile")}),document.getElementById("profile-form")?.addEventListener("submit",e=>{e.preventDefault(),this.saveProfileChanges()})}async loadProfileData(){try{const e=localStorage.getItem("authToken");if(!e)return;console.log(" loadProfileData - currentAvatar:",this.currentAvatar);const t=await fetch("/api/profile",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const n=await t.json();console.log(" Backend data received, currentAvatar remains:",this.currentAvatar),document.getElementById("options-nickname").value=n.nickname||"",document.getElementById("options-status").value=n.status||"online",this.updateProfileDisplay(n)}}catch(e){console.error("Failed to load profile data:",e)}}updateOptionsPageAvatar(e){const t=document.querySelector(".options-page .avatar-item.neon-border-yellow img");t&&(t.src=`/imgs/avatars/${e}.png`,t.onerror=()=>{t.src="/imgs/avatars/default.png"})}updateProfileDisplay(e){const t=document.getElementById("profile-avatar-img");t&&e.avatar&&(t.src=`/imgs/avatars/${e.avatar}.png`,t.onerror=()=>{t.src="/imgs/avatars/default.png"});const n=document.getElementById("profile-nickname"),i=document.getElementById("profile-email"),r=document.getElementById("profile-status"),a=document.getElementById("profile-gamestatistics"),c=document.getElementById("profile-friends");n&&(n.textContent=e.nickname||"N/A"),i&&(i.textContent=e.email||"N/A"),r&&(r.textContent=e.status||"online"),a&&(a.textContent=e.gameStatistics?`Played: ${e.gameStatistics.games_played||0}, Won: ${e.gameStatistics.games_won||0}`:"No games played"),c&&(c.textContent=e.friendsCount!==void 0?e.friendsCount.toString():"0")}async loadAvatars(){try{console.log(" Loading avatars...");const e=await fetch("/api/profile/avatars");if(e.ok){const t=await e.json();console.log(" Avatars received:",t.avatars),console.log(" Rendering with currentAvatar:",this.currentAvatar),this.renderAvatars(t.avatars)}}catch(e){console.error("Failed to load avatars:",e)}}getAvatarUrl(e){if(console.log(" getAvatarUrl called with:",e),!e||e==="default"||e==="default1")return`/imgs/avatars/${e||"default"}.png`;if(e.startsWith("custom_")){const n=/\.(jpg|png|gif|webp)$/i.test(e)?`/uploads/avatars/${e}`:`/uploads/avatars/${e}.jpg`;return console.log(" Custom avatar URL:",n),n}return`/imgs/avatars/${e}.png`}renderAvatars(e){const t=document.getElementById("avatar-grid");t&&(console.log(" Rendering avatars. Current:",this.currentAvatar),t.innerHTML=e.map(n=>{if(n==="upload")return`
            <div class="avatar-item cursor-pointer p-2 rounded-lg border-2 border-gray-700 transition-all duration-300" 
                 data-avatar="upload">
              <div class="w-12 h-12 mx-auto bg-gray-800 rounded flex items-center justify-center border-2 border-dashed border-green-400">
                <i class="fas fa-upload text-green-400 text-lg"></i>
              </div>
              <p class="text-center text-xs text-gray-300 mt-1">Upload</p>
            </div>
          `;const i=n.startsWith("custom_"),r=this.getAvatarUrl(n),a=n===this.currentAvatar;return console.log(" Rendering avatar:",n,"URL:",r,"Selected:",a),`
          <div class="avatar-item cursor-pointer p-2 rounded-lg border-2 transition-all duration-300 ${a?"border-yellow-400 shadow-lg shadow-yellow-400/50":"border-gray-700"}" data-avatar="${n}">
            <div class="relative">
              <img src="${r}" alt="${n}" 
                   class="w-12 h-12 mx-auto object-cover rounded"
                   onerror="console.error('Failed to load:', this.src); this.src='/imgs/avatars/default.png'">
              ${i?`
                <button class="delete-custom-avatar absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hover:bg-red-600"
                        data-avatar="${n}">
                  
                </button>
              `:""}
            </div>
            <p class="text-center text-xs text-gray-300 mt-1">${this.getAvatarDisplayName(n)}</p>
          </div>
        `}).join(""),this.addAvatarEventListeners())}addAvatarEventListeners(){document.querySelectorAll(".avatar-item").forEach(e=>{e.addEventListener("click",t=>{const n=t.target;if(n.classList.contains("delete-custom-avatar")){t.stopPropagation();const a=n.getAttribute("data-avatar");a&&this.deleteCustomAvatar(a);return}const r=n.closest(".avatar-item")?.getAttribute("data-avatar");r==="upload"?this.triggerFileUpload():r&&this.selectAvatar(r)})})}triggerFileUpload(){let e=document.getElementById("avatar-file-input");e||(e=document.createElement("input"),e.type="file",e.id="avatar-file-input",e.accept="image/jpeg,image/png,image/gif,image/webp",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",t=>{this.handleFileUpload(t)})),e.click()}async handleFileUpload(e){const t=e.target;if(!t.files||t.files.length===0)return;const n=t.files[0];if(this.validateFile(n))try{const i=localStorage.getItem("authToken");if(!i)return;this.showUploadProgress();const r=new FormData;r.append("avatar",n);const a=await fetch("/api/profile/avatar/upload",{method:"POST",headers:{Authorization:`Bearer ${i}`},body:r});if(a.ok){const c=await a.json();console.log(" Avatar uploaded successfully:",c),await this.loadAvatars(),await this.loadProfileData(),this.hideUploadProgress(),this.showNotification("Avatar uploaded successfully!","success")}else{const c=await a.json();throw new Error(c.error||"Upload failed")}}catch(i){console.error(" Avatar upload failed:",i),this.hideUploadProgress(),this.showNotification("Failed to upload avatar: "+i,"error")}finally{t.value=""}}async deleteCustomAvatar(e){if(confirm("Are you sure you want to delete this custom avatar?"))try{const t=localStorage.getItem("authToken");if(!t)return;if((await fetch("/api/profile/avatar",{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).ok)this.showNotification("Avatar deleted successfully!","success"),await this.loadAvatars(),await this.loadProfileData();else throw new Error("Failed to delete avatar")}catch(t){console.error("Avatar delete failed:",t),this.showNotification("Failed to delete avatar","error")}}validateFile(e){return["image/jpeg","image/png","image/gif","image/webp"].includes(e.type)?e.size>5242880?(this.showNotification("File size must be less than 5MB","error"),!1):!0:(this.showNotification("Please select a valid image file (JPEG, PNG, GIF, WebP)","error"),!1)}showUploadProgress(){const e=document.createElement("div");e.id="upload-progress",e.className="fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg",e.textContent="Uploading avatar...",document.body.appendChild(e)}hideUploadProgress(){const e=document.getElementById("upload-progress");e&&e.remove()}showNotification(e,t){const n=document.createElement("div");n.className=`fixed top-4 right-4 px-4 py-2 rounded-lg ${t==="success"?"bg-green-600 text-white":"bg-red-600 text-white"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}getCustomAvatarUrl(e){return`/uploads/avatars/${e}`}getAvatarDisplayName(e){return e==="upload"?"Upload":e.startsWith("custom_")?"Custom":e.charAt(0).toUpperCase()+e.slice(1)}async selectAvatar(e){console.log(" Selecting avatar:",e),this.currentAvatar=e,this.highlightSelectedAvatar(),await this.updateAvatar(e),console.log(" Avatar selection complete")}highlightSelectedAvatar(){console.log(" highlightSelectedAvatar - currentAvatar:",this.currentAvatar),document.querySelectorAll(".avatar-item").forEach(e=>{const n=e.getAttribute("data-avatar")===this.currentAvatar;e.setAttribute("data-selected",n.toString()),n?(e.classList.add("border-yellow-400","shadow-lg","shadow-yellow-400/50"),e.classList.remove("border-gray-700")):(e.classList.remove("border-yellow-400","shadow-lg","shadow-yellow-400/50"),e.classList.add("border-gray-700"))})}async updateAvatar(e){try{const t=localStorage.getItem("authToken");if(!t)return;if(console.log(" Sending avatar update to backend:",e),!(await fetch("/api/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({avatar:e})})).ok)throw new Error("Failed to update avatar");console.log(" Backend avatar update successful")}catch(t){console.error("Avatar update failed:",t)}}async saveProfileChanges(){const e=document.getElementById("options-nickname").value,t=document.getElementById("options-status").value;try{const n=localStorage.getItem("authToken");if(!n)return;(await fetch("/api/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({nickname:e,status:t})})).ok&&(console.log("Profile updated successfully!"),this.updateProfileDisplay({nickname:e,status:t,avatar:this.currentAvatar,email:"user@example.com",gameStatistics:{games_played:0,games_won:0},friendsCount:0}),document.querySelector(".options-page")?.classList.add("hidden"),document.querySelector(".profile-page")?.classList.remove("hidden"),console.log(" Profile page updated with avatar:",this.currentAvatar))}catch(n){console.error("Profile update failed:",n)}}}window.ProfileOptions=ft;function pt(){const s=document.getElementById("hamburger"),e=document.getElementById("close-menu"),t=document.querySelector(".main-nav");if(!s||!e||!t)return;const n=r=>{r?(t.classList.remove("hidden","md:flex"),t.classList.add("fixed","flex","flex-col","top-16","left-0","right-0","bg-dark","p-4","space-y-4","border-t","border-gray-800","z-40"),e.classList.remove("hidden"),s.classList.add("hidden")):(t.classList.add("hidden","md:flex"),t.classList.remove("fixed","flex","flex-col","top-16","left-0","right-0","bg-dark","p-4","space-y-4","border-t","border-gray-800","z-40"),e.classList.add("hidden"),s.classList.remove("hidden"))};s.addEventListener("click",()=>n(!0)),e.addEventListener("click",()=>n(!1)),t.querySelectorAll("a[data-link]").forEach(r=>{r.addEventListener("click",()=>n(!1))}),document.addEventListener("click",r=>{const a=r.target;!t.classList.contains("hidden")&&!t.contains(a)&&a!==s&&a!==e&&n(!1)}),window.addEventListener("resize",()=>{window.innerWidth>=768?(t.classList.remove("fixed","flex","flex-col","top-16","left-0","right-0","bg-dark","p-4","space-y-4","border-t","border-gray-800","z-40"),t.classList.remove("hidden"),t.classList.add("md:flex"),e.classList.add("hidden"),s.classList.remove("hidden")):(t.classList.add("hidden"),t.classList.remove("md:flex"),e.classList.add("hidden"),s.classList.remove("hidden"))})}class In{constructor(){this.matches=[],this.stats=null}async loadStatistics(){try{console.log("Loading statistics...");const[e,t]=await Promise.all([fetch("/api/my-statistics",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}}),fetch("/api/my-matches?limit=50",{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}})]);if(!e.ok)throw new Error(`Stats API failed: ${e.status}`);if(!t.ok)throw new Error(`Matches API failed: ${t.status}`);this.stats=await e.json();const n=await t.json();this.matches=n.matches||[],console.log("Statistics loaded:",this.stats),console.log("Matches loaded:",this.matches.length),this.displayStatistics(),this.drawCharts(),this.displayMatchHistory()}catch(e){console.error("Failed to load statistics:",e),this.showErrorMessage("Failed to load statistics. Please try again.")}}displayStatistics(){if(!this.stats)return;const e=this.stats.games_played>0?this.stats.games_won/this.stats.games_played*100:0,t=this.stats.games_played>0?this.stats.total_score/this.stats.games_played:0;this.updateElement("win-rate-percentage",`${e.toFixed(1)}%`),this.updateElement("avg-score-value",t.toFixed(1)),this.updateElement("games-played",this.stats.games_played.toString());const n=`${this.stats.games_won} wins / ${this.stats.games_lost} losses`;if(this.updateElement("win-loss-text",n),this.stats.last_game_date){const i=new Date(this.stats.last_game_date);this.updateElement("last-game",i.toLocaleDateString())}else this.updateElement("last-game","Never")}drawCharts(){this.drawWinRateChart(),this.drawAvgScoreChart()}drawWinRateChart(){const e=document.getElementById("win-rate-chart");if(!e||!this.stats)return;const t=e.getContext("2d");if(!t)return;const n=e.width/2,i=e.height/2,r=70;t.clearRect(0,0,e.width,e.height);const a=this.stats.games_played>0?this.stats.games_won/this.stats.games_played:0;t.beginPath(),t.arc(n,i,r,0,2*Math.PI),t.strokeStyle="#374151",t.lineWidth=8,t.stroke(),a>0&&(t.beginPath(),t.arc(n,i,r,-Math.PI/2,2*Math.PI*a-Math.PI/2),t.strokeStyle="#10B981",t.lineWidth=8,t.lineCap="round",t.stroke(),t.shadowColor="#10B981",t.shadowBlur=10,t.stroke(),t.shadowBlur=0)}drawAvgScoreChart(){const e=document.getElementById("avg-score-chart");if(!e||!this.stats)return;const t=e.getContext("2d");if(!t)return;const n=e.width/2,i=e.height/2,r=70;t.clearRect(0,0,e.width,e.height);const a=this.stats.games_played>0?this.stats.total_score/this.stats.games_played:0,c=Math.min(a/10,1);if(t.beginPath(),t.arc(n,i,r,0,2*Math.PI),t.strokeStyle="#374151",t.lineWidth=8,t.stroke(),c>0){t.beginPath(),t.arc(n,i,r,-Math.PI/2,2*Math.PI*c-Math.PI/2);let l="#EF4444";c>.7?l="#10B981":c>.4&&(l="#F59E0B"),t.strokeStyle=l,t.lineWidth=8,t.lineCap="round",t.stroke(),t.shadowColor=l,t.shadowBlur=10,t.stroke(),t.shadowBlur=0}}displayMatchHistory(){const e=document.getElementById("match-history-container");if(e){if(this.matches.length===0){e.innerHTML=`
        <div class="text-center py-8">
          <div class="text-gray-400 text-lg mb-4">No matches played yet</div>
          <p class="text-gray-500">Start playing to see your match history here!</p>
        </div>
      `;return}e.innerHTML=this.matches.map(t=>this.renderMatchCard(t)).join("")}}renderMatchCard(e){const t=e.opponent_nickname||"AI",n=new Date(e.played_at),i=this.getTimeAgo(n);return`
      <div class="match-card ${e.result} bg-gray-800 rounded-lg p-4 border-l-4 hover:bg-gray-750 transition-colors">
        <div class="flex items-center justify-between">
          <!-- Opponent Info -->
          <div class="flex items-center space-x-3 w-1/3 overflow-hidden">
            <img src="/imgs/avatars/${e.opponent_avatar||"default"}.png" 
                 alt="${t}" 
                 class="w-12 h-12 rounded-full border-2 border-gray-600"
                 onerror="this.src='/imgs/avatars/default.png'">
            <div>
              <div class="font-medium text-gray-200">${t}</div>
              <div class="text-sm text-gray-400">
                ${e.game_type} ${e.game_mode?` ${e.game_mode}`:""}
              </div>
            </div>
          </div>

          <!-- Score -->
          <div class="text-center">
            <div class="text-2xl font-bold ${this.getScoreColor(e.result)}">
              ${e.opponent_score} - ${e.my_score}
            </div>
          </div>

          <!-- Result & Date -->
          <div class="text-right w-1/3">
            <div class="result-badge ${e.result} px-3 py-1 rounded-full text-xs font-bold uppercase">
              ${e.result}
            </div>
            <div class="text-xs text-gray-500 mt-1">${i}</div>
          </div>
        </div>
      </div>
    `}updateElement(e,t){const n=document.getElementById(e);n?(n.textContent=t,console.log(`Updated ${e}:`,t)):console.warn(`Element not found: ${e}`)}getScoreColor(e){switch(e){case"won":return"text-green-400";case"lost":return"text-red-400";case"draw":return"text-yellow-400";default:return"text-gray-400"}}getTimeAgo(e){const n=new Date().getTime()-e.getTime(),i=Math.floor(n/(1e3*60*60*24));if(i===0){const r=Math.floor(n/36e5);if(r===0){const a=Math.floor(n/6e4);return a<=1?"Just now":`${a}m ago`}return`${r}h ago`}else return i===1?"Yesterday":i<7?`${i}d ago`:e.toLocaleDateString()}showErrorMessage(e){const t=document.getElementById("statistics-container");t&&(t.innerHTML=`
        <div class="text-center py-8">
          <div class="text-red-400 text-lg mb-4">Error</div>
          <p class="text-gray-400">${e}</p>
        </div>
      `)}}let pe;function Bn(){pe?console.error("Statistics page element not found"):(pe=new In,pe.loadStatistics())}const Cn=document.getElementById("search-bar"),Tn=document.getElementById("no-results"),_n=document.getElementById("no-friends"),An=document.getElementById("no-blocked"),Pn=document.getElementById("no-requests"),Rn=document.getElementById("find-user"),Mn=document.getElementById("search-results"),qn=document.getElementById("search-list"),Nn=document.getElementById("chat-history"),On=document.getElementById("friends-list"),Fn=document.getElementById("header-user-name"),Dn=document.getElementById("header-profile-pic"),Hn=document.getElementById("header-pic"),$n=document.getElementById("profile-pop-up"),Un=document.getElementById("close-profile-view-btn"),Gn=document.getElementById("profile-view-pic"),zn=document.getElementById("profile-view-name"),jn=document.getElementById("side-bar-menu"),Vn=document.getElementById("search-list-info"),Yn=document.getElementById("chat-input"),Wn=document.getElementById("chat-messages-area"),Jn=document.getElementById("chat-footer"),Xn=document.getElementById("chat-friend-options"),Kn=document.getElementById("friends-nav-options"),Qn=document.getElementById("friends-blocked-nav-options"),Zn=document.getElementById("friends-requests-nav-options"),es=document.getElementById("users-nav-options"),ts=document.getElementById("chat-friend-options-btn");document.getElementById("tournament-chat");const ns=document.getElementById("tournament-chat-main"),ss=document.getElementById("chat-main"),os=document.getElementById("friends-menu-extension"),is=document.getElementById("blocked-list"),rs=document.getElementById("requests-list"),as=document.getElementById("request-from"),cs=document.getElementById("notification-dot-chats"),ls=document.getElementById("notification-dot-friends"),ds=document.getElementById("notification-dot-requests");document.getElementById("live-chat-link");const hs=document.getElementById("live-chat-notification"),us=document.getElementById("add-friend-btn"),ms=document.getElementById("request-sent-info"),fs=document.getElementById("blocked-by-user-options");document.getElementById("view-profile-btn");document.querySelector(".main-nav");const ps=document.getElementById("accept-request-btn"),gs=document.getElementById("decline-request-btn"),ys=document.getElementById("confirm-remove-friend"),vs=document.getElementById("remove-friend-nickname"),ws=document.getElementById("remove-friend-yes-btn"),ks=document.getElementById("remove-friend-no-btn"),bs=document.getElementById("chat-blocked-friend-options"),Ls=document.getElementById("chat-blocked-by-friend-options"),Es=document.getElementById("chat-footer-blocked"),Ss=document.getElementById("send-msg-btn"),xs=document.getElementById("no-chats"),Is=document.getElementById("go-to-bottom-icon"),Bs=document.getElementById("new-msgs-count"),Cs=document.getElementById("go-to-bottom-btn"),Ts=document.querySelector(".chat-container"),_s=document.querySelector(".reconnect-info"),As=document.getElementById("status-dot"),Ps=document.getElementById("online-status"),Rs=document.getElementById("chat-header"),Ms=document.getElementById("tournament-header"),qs=document.getElementById("game-invitation-banner"),Ns=document.getElementById("game-invite-from");document.getElementById("accept-game-invite-btn");const Os=document.getElementById("decline-game-invite-btn"),o={searchBar:Cn,noResults:Tn,noFriends:_n,noBlocked:An,noRequests:Pn,findUser:Rn,searchResults:Mn,searchList:qn,chatHistory:Nn,friendsList:On,headerName:Fn,headerPic:Dn,headerPicArea:Hn,profileView:$n,closeProfileViewBtn:Un,profileViewPic:Gn,profileViewName:zn,sideBarMenu:jn,searchInfo:Vn,chatInput:Yn,chatMsgArea:Wn,chatFooter:Jn,chatsMenuOptions:Xn,friendsMenuOptions:Kn,friendsMenuExBlockedOptions:Qn,friendsMenuExRequestsOptions:Zn,usersMenuOptions:es,chatOptionsBtn:ts,tournamentMainChatArea:ns,chatMainArea:ss,friendsMenuExtension:os,blockedList:is,requestsList:rs,requesterID:as,chatsNotification:cs,friendsNotification:ls,requestsNotification:ds,liveChatNotification:hs,addFriendBtn:us,requestSentInfo:ms,blockedByUserOptions:fs,acceptRequestBtn:ps,declineRequestBtn:gs,confirmRemoveFriend:ys,removeFriendNick:vs,removeFriendYesBtn:ws,removeFriendNoBtn:ks,chatsMenuBlockedOptions:bs,chatsMenuBlockedByOptions:Ls,chatFooterBlocked:Es,sendMsgBtn:Ss,noChats:xs,goToBottomIcon:Is,newMsgsCount:Bs,goToBottomBtn:Cs,chatContainer:Ts,reconnectInfo:_s,statusDot:As,onlineStatus:Ps,chatHeader:Rs,tournamentHeader:Ms,gameInviteBanner:qs,gameInviteFrom:Ns,declineGameInviteBtn:Os};class T{constructor(){this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.logout=!1,this.connectionLost=!1,this.wasConnected=!1}static getInstance(){return T.instance||(console.log("[LiveChat] Creating new ChatSocketManager instance"),T.instance=new T),T.instance}on(e,t){this.socket?.on(e,t)}emit(e,...t){this.socket?.emit(e,...t)}disconnect(){this.logout=!0,this.socket?.disconnect()}isConnected(){return this.socket?.connected??!1}lostConnection(){return this.connectionLost}connect(){return new Promise((e,t)=>{const n=localStorage.getItem("authToken");if(!n)return t(new Error("[LiveChat] No authentication token found"));this.socket=Y({path:"/socket.io/livechat",auth:{token:n},query:{token:n},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay,reconnectionDelayMax:5e3,timeout:1e4,secure:!0,rejectUnauthorized:!1,withCredentials:!0,upgrade:!0,rememberUpgrade:!0}),this.socket.on("connect",()=>{console.log("[LiveChat] Socket connected:",this.socket?.id),e()}),this.socket.on("connect_error",i=>{console.error("[LiveChat] Connection error:",i),t(i),this.connectionLost=!0,this.wasConnected||(o.reconnectInfo.innerText=`Cannot connect
Retrying...`,o.chatContainer.classList.add("hidden"),o.reconnectInfo.classList.remove("hidden"))}),this.socket.on("disconnect",()=>{this.logout?console.log("[Live Chat] Socket disconnected (Logout)"):(console.warn("[Live Chat] Socket disconnected (Lost Connection)"),this.connectionLost=!0,this.wasConnected=!0,o.reconnectInfo.innerText=`Connection lost
Reconnecting...`,o.chatContainer.classList.add("hidden"),o.reconnectInfo.classList.remove("hidden"))}),this.socket.io.on("reconnect_attempt",i=>{console.warn(`[Live Chat] Reconnecting... Attempt ${i}`)}),this.socket.io.on("reconnect",i=>{console.log(`[Live Chat] Reconnected after ${i} attempts`),this.connectionLost=!1,o.chatContainer.classList.remove("hidden"),o.reconnectInfo.classList.add("hidden"),gt()}),this.socket.io.on("reconnect_failed",()=>{console.error("[LiveChat] Max reconnection attempts reached. Please refresh the page."),o.reconnectInfo.innerText=`Reconnection failed
Please refresh the page`})})}searchDbUsers(e){return new Promise(t=>{this.socket?.emit("search in users",e,n=>{t(n)})})}searchDbFriendships(){return new Promise(e=>{this.socket?.emit("search in friendships",t=>{e(t)})})}searchDbBlocked(){return new Promise(e=>{this.socket?.emit("search for blocked",t=>{e(t)})})}searchDbRequests(){return new Promise(e=>{this.socket?.emit("search in requests",t=>{e(t)})})}checkRequestSent(e){return new Promise(t=>{this.socket?.emit("check request sent",e,n=>{t(n)})})}recordRequest(e){return new Promise(t=>{this.socket?.emit("record request",e,n=>{t(n)})})}acceptFriendRequest(e){return new Promise(t=>{this.socket?.emit("accept friend request",e,n=>{t(n)})})}declineFriendRequest(e){return new Promise(t=>{this.socket?.emit("decline friend request",e,n=>{t(n)})})}updateRequestStat(e){return new Promise(t=>{this.socket?.emit("update request status",e,()=>{t()})})}removeFriend(e){return new Promise(t=>{this.socket?.emit("remove friend",e,n=>{t(n)})})}blockUser(e){return new Promise(t=>{this.socket?.emit("block user",e,n=>{t(n)})})}unblockUser(e){return new Promise(t=>{this.socket?.emit("unblock user",e,n=>{t(n)})})}checkBlocks(e){return new Promise(t=>{this.socket?.emit("check blocks",e,n=>{t(n)})})}loadMessages(e){return new Promise(t=>{this.socket?.emit("load messages",e,n=>{t(n)})})}loadMoreMessages(e,t){return new Promise(n=>{this.socket?.emit("load more messages",e,t,i=>{n(i)})})}recordMessage(e,t,n){return new Promise(i=>{this.socket?.emit("record message",e,t,n,r=>{i(r)})})}loadChats(){return new Promise(e=>{this.socket?.emit("load chats",t=>{e(t)})})}serverAlive(){return new Promise(e=>{this.socket?.timeout(1e3).emit("ping",t=>{e(!t)})})}getOnlineStatus(){return new Promise(e=>{this.socket?.emit("get online status",d,t=>{e(t)})})}loadTournamentMessages(){return new Promise(e=>{this.socket?.emit("load tournament messages",t=>{e(t)})})}loadMoreTournamentMessages(e){return new Promise(t=>{this.socket?.emit("load more tournament messages",e,n=>{t(n)})})}recordOrCheckGameInvitation(e){return new Promise(t=>{this.socket?.emit("record or check game invitation",d,e,n=>{t(n)})})}removeInvitation(e){return new Promise(t=>{this.socket?.emit("delete invitation",d,e,()=>{t()})})}}const y=T.getInstance();let se,Se=!1,W;function Fs(s){W=s}o.headerPicArea.addEventListener("click",()=>{o.profileViewName.innerHTML=o.headerName.innerHTML,o.headerPic.src.match("none")||(o.profileViewPic.src=o.headerPic.src,o.profileViewPic.classList.remove("hidden")),o.profileView.classList.remove("hidden")});o.headerName.addEventListener("click",()=>{o.profileViewName.innerHTML=o.headerName.innerHTML,o.headerPic.src.match("none")||(o.profileViewPic.src=o.headerPic.src,o.profileViewPic.classList.remove("hidden")),o.profileView.classList.remove("hidden")});o.closeProfileViewBtn.addEventListener("mouseup",()=>{o.profileView.classList.add("hidden"),o.profileViewPic.classList.add("hidden")});o.chatOptionsBtn.addEventListener("mouseup",()=>{o.chatMsgArea.classList.add("hidden"),o.chatFooter.classList.add("hidden"),o.chatFooterBlocked.classList.add("hidden"),eo(),o.goToBottomIcon.classList.add("hidden")});const Ds=document.querySelectorAll(".close-chat-options-btn");Ds.forEach(s=>{s.addEventListener("mouseup",async()=>{await re(),o.chatsMenuOptions.classList.add("hidden"),o.chatsMenuBlockedOptions.classList.add("hidden"),o.chatsMenuBlockedByOptions.classList.add("hidden"),o.chatMsgArea.classList.remove("hidden"),o.goToBottomIcon.classList.remove("hidden")})});const Hs=document.querySelectorAll(".view-profile-btn");Hs.forEach(s=>{s.addEventListener("mouseup",()=>{o.profileViewName.innerHTML=o.headerName.innerHTML,o.headerPic.src.match("none")||(o.profileViewPic.src=o.headerPic.src,o.profileViewPic.classList.remove("hidden")),o.profileView.classList.remove("hidden")})});o.addFriendBtn.addEventListener("mouseup",()=>{Ys()});o.acceptRequestBtn.addEventListener("mouseup",()=>{Ws()});o.declineRequestBtn.addEventListener("mouseup",()=>{Js()});const $s=document.querySelectorAll(".remove-from-friends-btn");$s.forEach(s=>{s.addEventListener("mouseup",()=>{o.confirmRemoveFriend.classList.remove("hidden"),o.removeFriendNick.innerHTML=o.headerName.innerHTML,k.classList.add("hidden")})});o.removeFriendNoBtn.addEventListener("mouseup",()=>{o.confirmRemoveFriend.classList.add("hidden"),k.classList.remove("hidden")});o.removeFriendYesBtn.addEventListener("mouseup",()=>{Xs(),o.confirmRemoveFriend.classList.add("hidden")});const Us=document.querySelectorAll(".block-btn");Us.forEach(s=>{s.addEventListener("mouseup",()=>{Ks()})});const Gs=document.querySelectorAll(".unblock-btn");Gs.forEach(s=>{s.addEventListener("mouseup",()=>{Qs()})});const zs=document.querySelectorAll(".open-chat-btn");zs.forEach(s=>{s.addEventListener("mouseup",()=>{Me()})});function H(s,e,t,n,i){const r=document.createElement("div"),a=document.createElement("span"),c=document.createElement("div"),l=document.createElement("span");s==="received"?(r.className="bg-cyan-600 rounded-lg py-0.5 px-2 max-w-xs w-fit break-words hyphens-auto whitespace-pre-wrap",i==="sent"?t==="prepend"?r.classList.add("mb-3"):r.classList.add("mt-2.5","mb-0.5"):r.classList.add("mb-0.5")):(r.className="self-end bg-pink-600 rounded-lg py-0.5 px-2 max-w-xs w-fit break-words hyphens-auto whitespace-pre-wrap",i==="received"?t==="prepend"?r.classList.add("mb-3"):r.classList.add("mt-2.5","mb-0.5"):r.classList.add("mb-0.5")),a.innerText=e,c.className="float-right mt-0.5",l.className="align-bottom text-[11px] font-medium text-gray-200 ml-3",l.innerText=n,r.appendChild(a),r.appendChild(c),c.appendChild(l),t==="prepend"?o.chatMsgArea.prepend(r):o.chatMsgArea.appendChild(r)}function js(s){const e=s.split(`
`);for(;e.length>0&&e[0].trim()==="";)e.shift();for(;e.length>0&&e[e.length-1].trim()==="";)e.pop();return e[0]=e[0].trim(),e[e.length-1]=e[e.length-1].trim(),e.join(`
`)}let xe=32;o.chatInput.addEventListener("input",()=>{o.chatInput.style.height="32px",o.chatInput.style.height=o.chatInput.scrollHeight+"px";let s=o.chatInput.clientHeight-xe;s&&(o.chatMsgArea.scrollTop+=s,s>0?(o.goToBottomIcon.classList.remove("bottom-[14%]"),o.goToBottomIcon.classList.add("bottom-[20%]")):(o.goToBottomIcon.classList.remove("bottom-[20%]"),o.goToBottomIcon.classList.add("bottom-[14%]"))),xe=o.chatInput.clientHeight,o.chatMsgArea.scrollHeight-(o.chatMsgArea.scrollTop+o.chatMsgArea.clientHeight)<25&&(o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight)});o.chatInput.addEventListener("keydown",s=>{if(s.key==="Enter"){if(s.shiftKey)return;s.preventDefault(),o.sendMsgBtn.click()}});o.sendMsgBtn.addEventListener("click",async()=>{if(!await y.serverAlive()){alert("Chat service is not available. Try again later");return}if(!o.chatInput.value.trim())return;const e=js(o.chatInput.value);let t=new Date().toISOString();if(await y.recordMessage(d,e,t)==="error"){alert("Something went wrong. Please try again later");return}const i=o.chatHistory.querySelector(`li[data-id="${d}"]`);if(!i)M(o.headerName.innerHTML,null,e,d,0,"prepend");else{const l=i.querySelector(".msg-preview");l.innerHTML=e,o.chatHistory.prepend(i)}const r=de(t),a=o.chatMsgArea.lastChild;let c=a?a.classList.contains("self-end")?"sent":"received":"none";c==="none"?N(t,t,"append",!0):c=N(W,t,"append")?"none":c,W=t,H("sent",e,"append",r,c),o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight,o.chatInput.value="",o.chatInput.style.height="32px",o.chatInput.focus()});o.goToBottomBtn.addEventListener("click",()=>{o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight,qe()});const Vs=document.querySelectorAll(".invite-to-play-btn");Vs.forEach(s=>{s.addEventListener("mouseup",()=>{no(s)})});o.declineGameInviteBtn.addEventListener("click",async()=>{await y.removeInvitation("received"),o.gameInviteBanner.classList.add("hidden")});async function Ys(){if(await y.recordRequest(d)==="error"){alert("Something went wrong. Please try again later");return}o.addFriendBtn.classList.add("hidden"),o.requestSentInfo.classList.remove("hidden")}async function Ws(){if(await y.acceptFriendRequest(d)==="error"){alert("Something went wrong. Please try again later");return}f(o.friendsMenuOptions),Oe();const e=o.requestsList.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.requestsList.hasChildNodes()||o.requestsList.appendChild(o.noRequests)}async function Js(){if(await y.declineFriendRequest(d)==="error"){alert("Something went wrong. Please try again later");return}o.addFriendBtn.classList.remove("hidden"),o.requestSentInfo.classList.add("hidden"),f(o.usersMenuOptions);const e=o.requestsList.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.requestsList.hasChildNodes()||o.requestsList.appendChild(o.noRequests)}async function Xs(){if(await y.removeFriend(d)==="error"){k.classList.remove("hidden"),alert("Something went wrong. Please try again later");return}z(),o.addFriendBtn.classList.remove("hidden"),o.requestSentInfo.classList.add("hidden"),f(o.usersMenuOptions);const e=o.chatHistory.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.chatHistory.hasChildNodes()||o.chatHistory.appendChild(o.noChats);const t=o.friendsList.querySelector(`li[data-id="${d}"]`);t&&t.remove(),o.friendsList.hasChildNodes()||o.friendsList.appendChild(o.noFriends);const n=o.blockedList.querySelector(`li[data-id="${d}"]`);n&&n.remove(),o.blockedList.hasChildNodes()||o.blockedList.appendChild(o.noBlocked),y.removeInvitation("sent"),y.removeInvitation("received")}async function Ks(){if(await y.blockUser(d)==="error"){alert("Something went wrong. Please try again later");return}yt(),k===o.chatsMenuOptions||k===o.chatsMenuBlockedByOptions?f(o.chatsMenuBlockedOptions):f(o.friendsMenuExBlockedOptions),y.removeInvitation("sent")}async function Qs(){if(await y.unblockUser(d)==="error"){alert("Something went wrong. Please try again later");return}const e=o.blockedList.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.blockedList.hasChildNodes()||o.blockedList.appendChild(o.noBlocked),Zs()}async function Zs(){const s=await y.checkBlocks(d);if(s==="error"||s==="not friends"){alert("Something went wrong. Please try again later");return}s==="blocked by target"?k===o.chatsMenuBlockedOptions?f(o.chatsMenuBlockedByOptions):f(o.blockedByUserOptions):k===o.chatsMenuBlockedOptions?f(o.chatsMenuOptions):f(o.friendsMenuOptions)}async function re(){if(d===$){o.chatFooter.classList.add("hidden"),o.chatFooterBlocked.classList.add("hidden");return}const s=await y.checkBlocks(d);if(s==="error"||s==="not friends"){alert("Something went wrong. Please try again later");return}s==="no blocks"?(o.chatFooterBlocked.classList.add("hidden"),o.chatFooter.classList.remove("hidden")):s==="mutual block"||s==="target blocked"?(o.chatFooter.classList.add("hidden"),o.chatFooterBlocked.innerHTML="You have blocked this user",o.chatFooterBlocked.classList.remove("hidden")):(o.chatFooter.classList.add("hidden"),o.chatFooterBlocked.innerHTML="You have been blocked by this user",o.chatFooterBlocked.classList.remove("hidden"))}async function eo(){const s=await y.checkBlocks(d);if(s==="error"||s==="not friends"){alert("Something went wrong. Please try again later");return}f(s==="no blocks"?o.chatsMenuOptions:s==="mutual block"||s==="target blocked"?o.chatsMenuBlockedOptions:o.chatsMenuBlockedByOptions)}function de(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function N(s,e,t,n=!1){if(s.split("T")[0]===e.split("T")[0]&&n===!1)return!1;const i=document.createElement("div");return n?i.className="self-center w-fit mb-4 bg-black text-yellow-300 text-opacity-90 rounded-full px-4 text-sm font-semibold justify-center items-center":i.className="self-center w-fit mt-10 mb-4 bg-black text-yellow-300 text-opacity-90 rounded-full px-4 text-sm font-semibold justify-center items-center",t==="prepend"?(i.dataset.dateISO=s,i.innerHTML=new Date(s).toLocaleDateString().replace(/\D/g,"."),o.chatMsgArea.prepend(i)):(i.dataset.dateISO=e,i.innerHTML=new Date(e).toLocaleDateString().replace(/\D/g,"."),o.chatMsgArea.appendChild(i)),!0}async function Me(){o.chatMsgArea.removeEventListener("scroll",Je),y.emit("update chat and target info",d,"chatID"),to(),d!==$&&(await y.getOnlineStatus()==="Online"?(o.statusDot.classList.remove("bg-red-600"),o.statusDot.classList.add("bg-green-500"),o.onlineStatus.innerHTML="Online"):(o.statusDot.classList.remove("bg-green-500"),o.statusDot.classList.add("bg-red-600"),o.onlineStatus.innerHTML="Offline")),Se=!1,o.chatMsgArea.replaceChildren(),k.classList.add("hidden"),o.tournamentMainChatArea.classList.add("hidden"),o.chatMainArea.classList.remove("hidden"),o.chatMsgArea.classList.remove("hidden"),re(),o.chatOptionsBtn.classList.remove("hidden"),o.chatInput.value="",o.chatInput.style.height="32px",o.goToBottomIcon.classList.remove("bottom-[20%]"),o.goToBottomIcon.classList.add("bottom-[14%]"),xe=32;const s=d===$?await y.loadTournamentMessages():await y.loadMessages(d);if(s.length===0)return;se=s[s.length-1].created_at;let e,t="none",n=s[0].created_at;W=s[0].created_at;for(const r of s)e=de(r.created_at),t=N(n,r.created_at,"prepend")?"date":t,r.sender_id===d?(H("received",r.message,"prepend",e,t),t="received"):(H("sent",r.message,"prepend",e,t),t="sent"),n=r.created_at;N(n,n,"prepend",!0),o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight,o.chatHistory.querySelector(`li[data-id="${d}"]`)?.querySelector(".notification-dot")?.classList.add("hidden"),o.chatMsgArea.addEventListener("scroll",Je)}async function to(){await y.recordOrCheckGameInvitation("check")==="received"?(o.gameInviteFrom.innerHTML=o.headerName.innerHTML,o.gameInviteBanner.classList.remove("hidden")):o.gameInviteBanner.classList.add("hidden")}async function Ie(s,e=""){const t=k.querySelector(".invite-to-play-btn");if(t){const i=t.querySelector("span");if(i&&t.removeChild(i),t.classList.remove("text-yellow-300","text-opacity-50","pointer-events-none"),t.classList.add("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black"),e){e==="offline"&&(t.classList.remove("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black"),t.classList.add("text-yellow-300","text-opacity-50","pointer-events-none"));return}}const n=s.querySelector(".invite-to-play-btn");if(n){const i=await y.recordOrCheckGameInvitation("check");if(i==="error")return alert("Something went wrong. Please try again later");if(i==="can send")return;if(i==="offline")n.classList.remove("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black"),n.classList.add("text-yellow-300","text-opacity-50","pointer-events-none");else{const r=document.createElement("span");r.className="text-yellow-300 text-opacity-50 italic justify-center -mt-1 flex text-sm font-normal",r.innerText="(Waiting for response...)",n.classList.remove("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black"),n.classList.add("text-yellow-300","text-opacity-50","pointer-events-none"),n.appendChild(r)}}}async function Je(){if(o.chatMsgArea.scrollTop<o.chatMsgArea.scrollHeight-o.chatMsgArea.clientHeight-50?(o.goToBottomIcon.classList.remove("opacity-0"),o.goToBottomIcon.classList.add("opacity-100"),o.goToBottomIcon.classList.remove("pointer-events-none")):(o.goToBottomIcon.classList.remove("opacity-100"),o.goToBottomIcon.classList.add("opacity-0"),o.goToBottomIcon.classList.add("pointer-events-none"),qe()),o.chatMsgArea.scrollTop>200||Se)return;const s=d===$?await y.loadMoreTournamentMessages(se):await y.loadMoreMessages(d,se);if(s.length===0){Se=!0;return}const e=o.chatMsgArea.scrollHeight;se=s[s.length-1].created_at;let t,n=o.chatMsgArea.children[0].dataset.dateISO,i=o.chatMsgArea.children[1].classList.contains("self-end")?"sent":"received";n.split("T")[0]===s[0].created_at.split("T")[0]&&o.chatMsgArea.children[0].remove();for(const r of s)t=de(r.created_at),i=N(n,r.created_at,"prepend")?"date":i,r.sender_id===d?(H("received",r.message,"prepend",t,i),i="received"):(H("sent",r.message,"prepend",t,i),i="sent"),n=r.created_at;N(n,n,"prepend",!0),o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight-e+200}async function no(s){const e=await y.recordOrCheckGameInvitation("record");if(e!=="success")return alert(e==="offline"?"This user is currently offline":e==="already sent"?"You have already invited this user":e==="already received"?"This user has already invited you":"Something went wrong. Please try again later");const t=document.createElement("span");t.className="text-yellow-300 text-opacity-50 italic justify-center -mt-1 flex text-sm font-normal",t.innerText="(Waiting for response...)",s.classList.remove("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black"),s.classList.add("text-yellow-300","text-opacity-50","pointer-events-none"),s.appendChild(t)}const $=0,g=T.getInstance();let E="Chats",C="All",d,k=o.usersMenuOptions,Be=0;function qe(){Be=0,o.newMsgsCount.classList.add("hidden")}async function f(s){k.classList.add("hidden"),await Ie(s),s.classList.remove("hidden"),k=s}function gt(){io(),Oe(),yt(),Fe()}async function Ne(s){try{await s.connect(),ao(),gt()}catch(e){console.error(e)}}function so(){if(g.lostConnection())return;o.sideBarMenu.querySelectorAll("button").forEach(e=>{e.innerText.match("Chats")?e.classList.add("neon-text-blue"):e.classList.remove("neon-text-blue")}),o.chatHistory.classList.remove("hidden"),o.friendsList.classList.add("hidden"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),E="Chats",o.friendsMenuExtension.classList.add("hidden"),o.chatsNotification.classList.add("hidden"),o.searchBar.classList.add("mb-4"),o.liveChatNotification.classList.add("hidden"),o.findUser.classList.add("hidden")}o.searchBar.addEventListener("focusout",s=>{o.searchList.classList.add("hidden"),o.searchResults.classList.add("hidden"),o.searchBar.value="",o.searchList.replaceChildren(),o.noResults.classList.add("hiiden"),o.findUser.classList.add("hidden"),E.match("Chats")&&o.chatHistory.classList.remove("hidden"),E.match("Friends")&&(C.match("All")?o.friendsList.classList.remove("hidden"):C.match("Blocked")?o.blockedList.classList.remove("hidden"):o.requestsList.classList.remove("hidden")),E.match("Users")&&o.findUser.classList.remove("hidden")});o.searchBar.addEventListener("input",()=>{o.chatHistory.classList.add("hidden"),o.friendsList.classList.add("hidden"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),o.searchResults.classList.remove("hidden"),o.searchList.classList.remove("hidden"),o.searchInfo.innerHTML="Search results",o.findUser.classList.add("hidden"),o.noResults.classList.add("hidden");let s=o.chatHistory.querySelectorAll("li"),e=o.chatHistory;if(E.match("Friends")&&(s=C.match("All")?o.friendsList.querySelectorAll("li"):C.match("Blocked")?o.blockedList.querySelectorAll("li"):o.requestsList.querySelectorAll("li"),e=C.match("All")?o.friendsList:C.match("Blocked")?o.blockedList:o.requestsList),E.match("Users")){o.searchBar.value!==""?(o.searchList.replaceChildren(),o.findUser.classList.add("hidden"),o.searchResults.classList.remove("hidden"),oo(o.searchBar.value)):(o.findUser.classList.remove("hidden"),o.searchResults.classList.add("hidden"));return}let t=0;o.searchList.replaceChildren(),s.forEach(n=>{if(n.dataset.username?.toLowerCase().match(o.searchBar.value.toLowerCase())&&o.searchBar.value!==""){const i=n.cloneNode(!0);i.original=n,o.searchList.appendChild(i),t++}}),t||(o.searchBar.value===""?(o.searchResults.classList.add("hidden"),e.classList.remove("hidden")):o.noResults.classList.remove("hidden"))});o.sideBarMenu.addEventListener("click",s=>{const e=s.target.closest("button");if(!e)return;o.sideBarMenu.querySelectorAll("button").forEach(i=>{i.classList.remove("neon-text-blue")}),e.classList.add("neon-text-blue");const n=o.friendsMenuExtension.querySelectorAll("button");n.forEach(i=>{i.classList.remove("neon-text-blue","border","border-zinc-400","bg-gray-800")}),n.forEach(i=>{i.innerText.match("All")&&i.classList.add("neon-text-blue","border","border-zinc-400","bg-gray-800")}),C="All",e.innerText.match("Chats")&&(E="Chats",o.chatHistory.classList.remove("hidden"),o.friendsList.classList.add("hidden"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),o.friendsMenuExtension.classList.add("hidden"),o.chatsNotification.classList.add("hidden"),o.searchBar.classList.add("mb-4"),o.findUser.classList.add("hidden"),o.chatHistory.scrollTop=0,M("Tournament System",null,"Test message",0,1,"append"),M("Test user",null,"Test user message",500,1,"append")),e.innerText.match("Friends")&&(E="Friends",o.chatHistory.classList.add("hidden"),o.friendsList.classList.remove("hidden"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),o.friendsMenuExtension.classList.remove("hidden"),o.searchBar.classList.remove("mb-4"),o.findUser.classList.add("hidden"),o.friendsList.scrollTop=0,o.friendsNotification.classList.add("hidden")),e.innerText==="Users"&&(o.searchBar.focus(),o.chatHistory.classList.add("hidden"),o.friendsList.classList.add("hidden"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),o.friendsMenuExtension.classList.add("hidden"),o.searchBar.classList.add("mb-4"),o.findUser.classList.remove("hidden"),E="Users")});o.friendsMenuExtension.addEventListener("click",s=>{const e=s.target.closest("button");if(!e)return;o.friendsMenuExtension.querySelectorAll("button").forEach(n=>{n.classList.remove("neon-text-blue","border","border-zinc-400","bg-gray-800")}),e.classList.add("neon-text-blue","border","border-zinc-400","bg-gray-800"),o.blockedList.classList.add("hidden"),o.requestsList.classList.add("hidden"),o.friendsList.classList.add("hidden"),e.innerText.match("All")?(o.friendsList.classList.remove("hidden"),o.friendsList.scrollTop=0):e.innerText.match("Blocked")?(o.blockedList.classList.remove("hidden"),o.blockedList.scrollTop=0):(o.requestsList.classList.remove("hidden"),o.requestsNotification.classList.add("hidden"),o.friendsNotification.classList.add("hidden"),o.requestsList.scrollTop=0),C=e.innerText});function J(s){if(d===$){o.chatHeader.classList.add("hidden"),o.tournamentHeader.classList.remove("hidden");return}if(o.chatHeader.classList.remove("hidden"),o.tournamentHeader.classList.add("hidden"),s&&s.dataset.username){const e=s.dataset.username,t=s.dataset.picSrc?s.dataset.picSrc:"none";if(o.headerName.innerHTML=e,e.length>24){let n=e.substring(0,21);for(;n.endsWith(" ")||n.endsWith(`
`)||n.endsWith("	");)n=n.slice(0,-1);n=n+"...",o.headerName.innerHTML=n}o.headerPic.src=t,o.headerPic.src.match("none")?o.headerPic.classList.add("hidden"):o.headerPic.classList.remove("hidden")}}function he(s,e,t,n,i){const r="http://www.w3.org/2000/svg",a=document.createElement("li"),c=document.createElement("div"),l=document.createElement("div"),m=document.createElement("img"),p=document.createElementNS(r,"svg"),b=document.createElement("p"),L=document.createElementNS(r,"circle"),O=document.createElementNS(r,"path"),F=document.createElement("div"),D=document.createElement("div");a.className="flex flex-col hover:bg-slate-500 hover:bg-opacity-20 cursor-pointer",c.className="flex items-center p-2",l.className="w-8 h-8 rounded-full overflow-hidden bg-white",m.className="w-full h-full object-cover hidden",m.src="none",m.alt="Profile pic",p.setAttribute("class","w-full h-full fill-pink-400"),p.setAttribute("viewBox","0 0 64 64"),L.setAttribute("cx","32"),L.setAttribute("cy","20"),L.setAttribute("r","12"),O.setAttribute("d","M12 52c0-11 9-20 20-20s20 9 20 20"),b.className="ml-3 font-bold text-[15px] max-w-40 whitespace-nowrap overflow-hidden text-ellipsis",b.innerHTML=e,F.className="notification-dot w-3 h-3 ml-auto mr-3 rounded-full notification-dot-color",D.className="ml-14 border-b-[0.5px] border-gray-600",a.appendChild(c),c.appendChild(l),l.appendChild(m),l.appendChild(p),p.appendChild(L),p.appendChild(O),c.appendChild(b),a.dataset.id=String(n),a.dataset.username=e,a.dataset.picSrc="none",s===o.requestsList&&i==="not viewed"&&c.appendChild(F),s.appendChild(a)}function M(s,e,t,n,i,r,a="msg"){const c="http://www.w3.org/2000/svg",l=document.createElement("li"),m=document.createElement("div"),p=document.createElement("div"),b=document.createElement("img"),L=document.createElementNS(c,"svg"),O=document.createElement("div"),F=document.createElement("p"),D=document.createElement("p"),X=document.createElementNS(c,"circle"),Ge=document.createElementNS(c,"path"),K=document.createElement("div"),At=document.createElement("div");l.className="flex flex-col hover:bg-slate-500 hover:bg-opacity-20 cursor-pointer",m.className="flex items-center p-2",p.className="w-9 h-9 rounded-full overflow-hidden bg-white",b.className="w-full h-full object-cover hidden",b.src="none",b.alt="Profile pic",L.setAttribute("class","w-full h-full fill-pink-400"),L.setAttribute("viewBox","0 0 64 64"),X.setAttribute("cx","32"),X.setAttribute("cy","20"),X.setAttribute("r","12"),Ge.setAttribute("d","M12 52c0-11 9-20 20-20s20 9 20 20"),O.className="flex flex-col max-w-40",F.className="ml-3 font-bold text-[15px] whitespace-nowrap overflow-hidden text-ellipsis",D.className="msg-preview ml-3 text-[13px] -mt-1 whitespace-nowrap overflow-hidden text-ellipsis",F.innerHTML=s,D.innerHTML=t,K.className="notification-dot flex h-[18px] min-w-[18px] max-w-fit ml-auto mr-2 p-1 justify-center items-center rounded-full text-xs font-bold notification-dot-color",K.classList.toggle("hidden",i===0),K.innerHTML=i>99?"99+":String(i),At.className="ml-14 border-b-[0.5px] border-gray-600",l.appendChild(m),a==="invitation"&&D.classList.add("text-yellow-300","italic","font-semibold"),n===$?(p.className="w-9 h-9 flex justify-center items-center text-yellow-400 text-2xl font-bold rounded-full bg-slate-700",p.innerHTML="T",m.appendChild(p)):(m.appendChild(p),p.appendChild(b),p.appendChild(L),L.appendChild(X),L.appendChild(Ge)),O.appendChild(F),O.appendChild(D),m.appendChild(O),m.appendChild(K),l.dataset.id=String(n),l.dataset.username=s,l.dataset.picSrc="none",o.noChats.remove(),r==="prepend"?o.chatHistory.prepend(l):o.chatHistory.appendChild(l),console.log("Added chat with name: %s id: %d",s,n)}o.friendsList.addEventListener("mousedown",s=>{const e=s.target.closest("li");!e||!o.friendsList.contains(e)||(d=Number(e.dataset.id),J(e),z(),o.tournamentMainChatArea.classList.add("hidden"),o.chatMainArea.classList.remove("hidden"),Ce())});o.blockedList.addEventListener("mousedown",s=>{const e=s.target.closest("li");!e||!o.blockedList.contains(e)||(d=Number(e.dataset.id),J(e),z(),o.tournamentMainChatArea.classList.add("hidden"),o.chatMainArea.classList.remove("hidden"),f(o.friendsMenuExBlockedOptions))});o.requestsList.addEventListener("mousedown",s=>{const e=s.target.closest("li");if(!(e&&e.dataset.username)||!o.requestsList.contains(e))return;d=Number(e.dataset.id),J(e),z(),o.tournamentMainChatArea.classList.add("hidden"),o.chatMainArea.classList.remove("hidden"),o.requesterID.innerHTML=e.dataset.username,f(o.friendsMenuExRequestsOptions);const t=e.querySelector(".notification-dot");t.classList.contains("hidden")||(t.classList.add("hidden"),De(d))});o.searchList.addEventListener("mousedown",s=>{const e=s.target.closest("li");if(e&&e.dataset.username){if(s.preventDefault(),d=Number(e.dataset.id),J(e),o.tournamentMainChatArea.classList.add("hidden"),o.chatMainArea.classList.remove("hidden"),E.match("Chats")){Me();return}z(),E.match("Friends")?C.match("All")?Ce():C.match("Blocked")?f(o.friendsMenuExBlockedOptions):(o.requesterID.innerHTML=e.dataset.username,f(o.friendsMenuExRequestsOptions),e.querySelector(".notification-dot")?.classList.contains("hidden")||(e.querySelector(".notification-dot")?.classList.add("hidden"),e.original.querySelector(".notification-dot")?.classList.add("hidden"),De(d))):Ce()}});o.chatHistory.addEventListener("click",s=>{const e=s.target.closest("li");if(e){if(e.hasAttribute("id")){o.chatMainArea.classList.add("hidden"),o.tournamentMainChatArea.classList.remove("hidden"),e.querySelector(".notification-dot")?.classList.add("hidden");return}d=Number(e.dataset.id),J(e),Me()}});async function oo(s){const e=await g.searchDbUsers(s);e.length>0?(o.noResults.classList.add("hidden"),e.forEach(t=>{he(o.searchList,t.nickname,null,t.id,"")})):o.noResults.classList.remove("hidden")}async function io(){const s=await g.loadChats();o.chatHistory.replaceChildren(),s.length>0?s.forEach(e=>{M(e.nickname,null,e.message,e.id,e.amount,"append")}):o.chatHistory.appendChild(o.noChats)}async function Oe(){const s=await g.searchDbFriendships();o.friendsList.replaceChildren(),s.length>0?s.forEach(e=>{he(o.friendsList,e.nickname,null,e.id,"")}):o.friendsList.appendChild(o.noFriends)}async function yt(){const s=await g.searchDbBlocked();o.blockedList.replaceChildren(),s.length>0?s.forEach(e=>{he(o.blockedList,e.nickname,null,e.id,"")}):o.blockedList.appendChild(o.noBlocked)}async function Fe(){const s=await g.searchDbRequests();o.requestsList.replaceChildren(),s.length>0?s.forEach(e=>{he(o.requestsList,e.nickname,null,e.id,e.status)}):o.requestsList.appendChild(o.noRequests)}async function ro(s){const e=await g.checkRequestSent(s);if(e==="error"){alert("Something went wrong. Please try again later");return}e==="sent"?(o.addFriendBtn.classList.add("hidden"),o.requestSentInfo.classList.remove("hidden")):(o.addFriendBtn.classList.remove("hidden"),o.requestSentInfo.classList.add("hidden")),f(o.usersMenuOptions)}async function Ce(){const s=await g.checkBlocks(d);if(s==="error"){alert("Something went wrong. Please try again later");return}if(s==="mutual block"||s==="target blocked")f(o.friendsMenuExBlockedOptions);else if(s==="blocked by target")f(o.blockedByUserOptions);else if(s==="no blocks")f(o.friendsMenuOptions);else if(s==="not friends"){const e=o.requestsList.querySelector(`li[data-id="${d}"]`);if(e){o.requesterID.innerHTML=e.dataset.username,f(o.friendsMenuExRequestsOptions),De(d),Fe();return}ro(d)}}async function De(s){await g.updateRequestStat(s)}async function z(){g.emit("update chat and target info",d,"targetID"),o.chatMsgArea.classList.add("hidden"),o.chatFooter.classList.add("hidden"),o.chatFooterBlocked.classList.add("hidden"),o.chatOptionsBtn.classList.add("hidden"),o.goToBottomIcon.classList.remove("opacity-100"),o.goToBottomIcon.classList.add("opacity-0"),o.goToBottomIcon.classList.add("pointer-events-none"),qe(),await g.getOnlineStatus()==="Online"?(o.statusDot.classList.remove("bg-red-600"),o.statusDot.classList.add("bg-green-500"),o.onlineStatus.innerHTML="Online"):(o.statusDot.classList.remove("bg-green-500"),o.statusDot.classList.add("bg-red-600"),o.onlineStatus.innerHTML="Offline")}function ao(){g.on("received request",s=>{Fe(),window.location.pathname!=="/livechat"&&o.liveChatNotification.classList.remove("hidden"),!E.match("Friends")&&d!==s&&o.friendsNotification.classList.remove("hidden"),!C.match("Requests")&&d!==s&&o.requestsNotification.classList.remove("hidden"),d===s&&(o.requesterID.innerHTML=o.headerName.innerHTML,f(o.friendsMenuExRequestsOptions))}),g.on("your request is accepted",s=>{d===s&&f(o.friendsMenuOptions),Oe();const e=o.requestsList.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.requestsList.hasChildNodes()||o.requestsList.appendChild(o.noRequests)}),g.on("your request is declined",s=>{d===s&&(o.addFriendBtn.classList.remove("hidden"),o.requestSentInfo.classList.add("hidden"));const e=o.requestsList.querySelector(`li[data-id="${d}"]`);e&&e.remove(),o.requestsList.hasChildNodes()||o.requestsList.appendChild(o.noRequests)}),g.on("got removed from friends",s=>{d===s&&(z(),o.addFriendBtn.classList.remove("hidden"),o.requestSentInfo.classList.add("hidden"),f(o.usersMenuOptions));const e=o.chatHistory.querySelector(`li[data-id="${s}"]`);e&&e.remove(),o.chatHistory.hasChildNodes()||o.chatHistory.appendChild(o.noChats);const t=o.friendsList.querySelector(`li[data-id="${s}"]`);t&&t.remove(),o.friendsList.hasChildNodes()||o.friendsList.appendChild(o.noFriends);const n=o.blockedList.querySelector(`li[data-id="${s}"]`);n&&n.remove(),o.blockedList.hasChildNodes()||o.blockedList.appendChild(o.noBlocked)}),g.on("you got blocked",s=>{d===s&&(o.chatMsgArea.classList.contains("hidden")?k===o.chatsMenuOptions?f(o.chatsMenuBlockedByOptions):k==o.friendsMenuOptions&&f(o.blockedByUserOptions):(re(),o.gameInviteBanner.classList.add("hidden")))}),g.on("you got unblocked",s=>{d===s&&(o.chatMsgArea.classList.contains("hidden")?k===o.chatsMenuBlockedByOptions?f(o.chatsMenuOptions):k===o.blockedByUserOptions&&f(o.friendsMenuOptions):re())}),g.on("received message",(s,e,t,n)=>{if(d===s){const i=de(n),r=o.chatMsgArea.lastChild;let a=r?r.classList.contains("self-end")?"sent":"received":"none";a==="none"?N(n,n,"append",!0):a=N(W,n,"append")?"none":a,Fs(n),H("received",t,"append",i,a),o.goToBottomIcon.classList.contains("opacity-100")?(o.newMsgsCount.innerHTML=Be===99?"99+":String(++Be),o.newMsgsCount.classList.remove("hidden"),o.goToBottomIcon.classList.remove("pointer-events-none")):o.chatMsgArea.scrollTop=o.chatMsgArea.scrollHeight;const c=o.chatHistory.querySelector(`li[data-id="${d}"]`);if(!c)M(e,null,t,s,0,"prepend");else{const l=c.querySelector(".msg-preview");l.innerHTML=t,o.chatHistory.prepend(c)}}}),g.on("update notification",(s,e,t,n)=>{E!=="Chats"&&o.chatsNotification.classList.remove("hidden"),window.location.pathname!=="/livechat"&&o.liveChatNotification.classList.remove("hidden");const i=o.chatHistory.querySelector(`li[data-id="${s}"]`);if(!i)M(e,null,t,s,n,"prepend");else{const r=i.querySelector(".notification-dot");r.classList.remove("hidden"),r.innerHTML=n>99?"99+":String(n);const a=i.querySelector(".msg-preview");a.innerHTML=t,a.classList.remove("text-yellow-300","italic","font-semibold"),o.chatHistory.prepend(i)}}),g.on("bye bye",s=>{d===s&&(o.statusDot.classList.remove("bg-green-500"),o.statusDot.classList.add("bg-red-600"),o.onlineStatus.innerHTML="Offline",Ie(k,"offline"))}),g.on("i am online",s=>{d===s&&(o.statusDot.classList.remove("bg-red-600"),o.statusDot.classList.add("bg-green-500"),o.onlineStatus.innerHTML="Online",Ie(k,"online"))}),g.on("received game invitation",(s,e)=>{d===s&&(o.chatHistory.querySelector(`li[data-id="${d}"]`)||M(e,null,"Game Invitation",s,0,"prepend"),o.gameInviteFrom.innerHTML=e,o.gameInviteBanner.classList.remove("hidden"))}),g.on("update notification - game",(s,e)=>{E!=="Chats"&&o.chatsNotification.classList.remove("hidden"),window.location.pathname!=="/livechat"&&o.liveChatNotification.classList.remove("hidden");const t=o.chatHistory.querySelector(`li[data-id="${s}"]`);if(!t)M(e,null,"Game Invitation",s,0,"prepend","invitation");else{t.querySelector(".notification-dot");const n=t.querySelector(".msg-preview");n.classList.add("text-yellow-300","italic","font-semibold"),n.innerHTML="Game Invitation",o.chatHistory.prepend(t)}}),g.on("invitation declined",s=>{if(d===s){const e=k.querySelector(".invite-to-play-btn");if(e){const t=e.querySelector("span");t&&e.removeChild(t),e.classList.remove("text-yellow-300","text-opacity-50","pointer-events-none"),e.classList.add("neon-text-yellow","neon-border-pink","hover:neon-bg-pink","hover:text-black")}}}),g.on("invitation canceled",s=>{d===s&&o.gameInviteBanner.classList.add("hidden")})}const vt=document.querySelector(".login-page"),He=document.querySelector(".profile-page"),U=document.querySelector(".game-page"),wt=document.querySelector(".newgame-page"),co=document.querySelector(".multiplayer-lobby"),lo=document.querySelector(".options-page"),ho=document.querySelector(".user-search-page"),uo=document.querySelector(".user-profile-page"),mo=document.querySelector(".oauth-result-page"),fo=document.querySelector(".nickname-page"),kt=document.querySelector(".tournament-lobby"),po=document.querySelector(".live-chat"),go=document.querySelector(".statistics-page");let ge=vt;function v(s){ge!==s&&(ge.classList.add("hidden"),s.classList.remove("hidden"),ge=s)}const A=R.getInstance(),bt=T.getInstance(),Xe=[{path:"/",view:Ao},{path:"/profile",view:Po,authRequired:!0},{path:"/game",view:oe,authRequired:!0},{path:"/tournament",view:Do,authRequired:!0},{path:"/statistics",view:Lo,authRequired:!0},{path:"/livechat",view:_o,authRequired:!0},{path:"/options",view:wo,authRequired:!0},{path:"/search",view:bo,authRequired:!0},{path:"/user/:id",view:Bt,authRequired:!0},{path:"/oAuthCallback",view:Bo},{path:"/choose-nickname",view:Co,preAuthRequired:!0}];function S(){const s=document.querySelector(".main-nav");s&&(I()?(s.classList.remove("hidden"),s.classList.add("md:flex")):(s.classList.add("hidden"),s.classList.remove("md:flex")))}async function yo(){const s=document.getElementById("options-nickname")?.value,e=document.getElementById("options-status")?.value;try{const t=localStorage.getItem("authToken");if(!t)return;if((await fetch("/api/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({nickname:s,status:e})})).ok)console.log("Profile updated successfully!"),v(He),await Tt();else throw new Error("Failed to update profile")}catch(t){console.error("Profile update failed:",t),alert("Failed to update profile")}}function vo(){document.getElementById("back-to-profile")?.addEventListener("click",s=>{s.preventDefault(),v(He)}),document.getElementById("profile-form")?.addEventListener("submit",async s=>{s.preventDefault(),await yo()})}function wo(){if(!I()){h("/");return}S(),v(lo),ko(),vo()}async function ko(){try{if(!localStorage.getItem("authToken"))return;new ft().init()}catch(s){console.error("Failed to load options data:",s)}}function bo(){if(!I()){h("/");return}S(),v(ho),Eo()}function Lo(){if(!I()){h("/");return}S(),v(go),Bn()}function Eo(){const s=document.getElementById("user-search-input"),e=document.getElementById("search-results");if(!s||!e){console.error("Search elements not found");return}const t=s.cloneNode(!0);s.parentNode?.replaceChild(t,s);let n;t.addEventListener("input",()=>{clearTimeout(n);const i=t.value.trim();if(console.log("Search input:",i),i.length<2){e.innerHTML='<p class="text-gray-400 text-center py-4">Type at least 2 characters to search</p>';return}n=setTimeout(async()=>{await Lt(i,e)},300)}),e.innerHTML='<p class="text-gray-400 text-center py-4">Type at least 2 characters to search</p>'}async function Lt(s,e){try{const t=localStorage.getItem("authToken");if(!t){h("/");return}e.innerHTML='<p class="text-gray-400 text-center py-4">Searching...</p>',console.log("Making search request for:",s);const n=await fetch(`/api/users/search?q=${encodeURIComponent(s)}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(console.log("Search response status:",n.status),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.json();console.log("Search results data:",i),i.users&&i.users.length>0?So(i.users,e):e.innerHTML='<p class="text-gray-400 text-center py-4">No users found matching your search</p>'}catch(t){console.error("Search failed:",t),e.innerHTML='<p class="text-red-400 text-center py-4">Search failed. Please try again.</p>'}}function Et(s){switch(s){case"online":return"text-green-400";case"away":return"text-yellow-400";case"busy":return"text-red-400";case"invisible":return"text-gray-400";default:return"text-gray-400"}}function So(s,e){console.log("Rendering search results:",s),e.innerHTML=s.map(t=>{const n=Io(t.friendship_status||"none");return`
            <div class="user-result flex items-center justify-between p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors border border-gray-700">
                <div class="flex items-center space-x-4">
                    <img src="/imgs/avatars/${t.avatar||"default"}.png"
                         class="w-12 h-12 rounded-full border-2 border-gray-600"
                         onerror="this.src='/imgs/avatars/default.png'">
                    <div>
                        <div class="text-white font-semibold text-lg">${t.nickname}</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm ${Et(t.status||"offline")}">
                                 ${t.status||"offline"}
                            </span>
                            ${n}
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    ${xt(t)}
                    <button class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 transition-colors view-profile-btn text-white font-medium"
                            data-user-id="${t.id}">
                        View Profile
                    </button>
                </div>
            </div>
        `}).join(""),xo(e)}function xo(s){s.querySelectorAll(".friend-request-btn").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault();const n=t.target,i=n.getAttribute("data-user-id");i&&(n.textContent="Sending...",n.setAttribute("disabled","true"),await It(parseInt(i))?(n.textContent="Request Sent",n.classList.remove("bg-blue-600","hover:bg-blue-700"),n.classList.add("bg-gray-600","cursor-not-allowed")):(n.textContent="Add Friend",n.removeAttribute("disabled")))})}),s.querySelectorAll(".view-profile-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const i=t.target.getAttribute("data-user-id");if(console.log("View profile clicked for user ID:",i),i){const r=parseInt(i);console.log("Parsed user ID:",r),isNaN(r)?console.error("Invalid user ID:",i):h(`/user/${r}`)}else console.error("No user ID found on button")})}),s.querySelectorAll(".remove-friend-btn").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault();const i=t.target.getAttribute("data-user-id");if(i&&confirm("Are you sure you want to remove this friend?")&&await St(parseInt(i))){const a=document.getElementById("user-search-input");a&&a.value.trim().length>=2&&await Lt(a.value.trim(),s)}})})}async function St(s){try{const e=localStorage.getItem("authToken");return e?(await fetch(`/api/friends/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}})).ok:(h("/"),!1)}catch(e){return console.error("Remove friend failed:",e),!1}}function xt(s){switch(s.friendship_status||"none"){case"accepted":return`<button class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition-colors remove-friend-btn text-white font-medium"
                           data-user-id="${s.id}">
                        Remove Friend
                    </button>`;case"pending":return`<button class="px-4 py-2 bg-gray-600 rounded-lg cursor-not-allowed text-white font-medium" disabled>
                        Request Sent
                    </button>`;default:return`<button class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors friend-request-btn text-white font-medium"
                           data-user-id="${s.id}">
                        Add Friend
                    </button>`}}function Io(s){switch(s){case"accepted":return'<span class="text-xs bg-green-600 px-2 py-1 rounded-full">Friend</span>';case"pending":return'<span class="text-xs bg-yellow-600 px-2 py-1 rounded-full">Pending</span>';default:return""}}async function It(s){try{const e=localStorage.getItem("authToken");if(!e)return h("/"),!1;console.log("Sending friend request to user:",s);const t=await fetch("/api/friends/request",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({targetUserId:s})});if(console.log("Friend request response:",t.status),t.ok)return console.log("Friend request sent successfully"),!0;{const n=await t.json().catch(()=>({error:"Unknown error"}));return console.error("Friend request failed:",n),!1}}catch(e){return console.error("Friend request network error:",e),!1}}function Bt(){if(!I()){h("/");return}S(),v(uo);const s=window.location.pathname.split("/").pop();s&&!isNaN(parseInt(s))?Ct(parseInt(s)):h("/search")}async function Bo(){const s=new URLSearchParams(window.location.search),e=s.get("code"),t=s.get("state");S();const n=document.getElementById("oauth-result-header"),i=document.getElementById("oauth-result-text");let r="Authentication Error",a="Error when trying to login through 42.";if(e!==null&&t!==null){const c=await fetch("/api/auth/42/callback?"+s.toString());if(c.ok){const l=await c.json();if(console.log(l),l.token&&l.action_required!==!1){localStorage.setItem("preAuthToken",l.token);const m=l.action_required==="nickname"?"/choose-nickname":l.action_required==="2fa"?"/2fa":null;if(m){window.location.href=m;return}}else if(l.token&&l.action_required===!1){localStorage.setItem("authToken",l.token),h("/profile");return}else if(!l.token&&I()){h("/profile");return}}}n&&(n.innerText=r),i&&(i.innerText=a),v(mo)}function Co(){S(),v(fo)}async function Ct(s){try{const e=localStorage.getItem("authToken");if(!e){console.error("No auth token found"),h("/");return}console.log("Loading user profile for ID:",s),console.log("Using endpoint:",`/api/user/${s}`);const t=await fetch(`/api/user/${s}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(console.log("User profile response status:",t.status),console.log("User profile response headers:",t.headers),t.ok){const n=await t.json();console.log("User profile data received:",n),Ke(n)}else{const n=await t.text();console.error("User profile error response:",n),console.log("Trying alternative endpoint...");const i=await fetch(`/api/users/${s}`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(console.log("Alternative endpoint status:",i.status),i.ok){const r=await i.json();console.log("Alternative endpoint data:",r),Ke(r)}else alert("User not found"),h("/search")}}catch(e){console.error("Network error loading user profile:",e),alert("Error loading user profile"),h("/search")}}function Ke(s){const e=document.getElementById("user-profile-avatar"),t=document.getElementById("user-profile-nickname"),n=document.getElementById("user-profile-status"),i=document.getElementById("user-profile-actions");if(e&&(e.src=`/imgs/avatars/${s.avatar||"default"}.png`,e.onerror=()=>{e.src="/imgs/avatars/default.png"}),t&&(t.textContent=s.nickname),n&&(n.textContent=s.status||"offline",n.className=`${Et(s.status||"offline")} text-lg`),i){const r=s.friendship_status||"none";i.innerHTML=xt({id:s.id,friendship_status:r}),To(s.id)}}function To(s){document.querySelector(".friend-request-btn")?.addEventListener("click",async t=>{t.preventDefault();const n=t.target;n.textContent="Sending...",n.setAttribute("disabled","true"),await It(s)?(n.textContent="Request Sent",n.classList.remove("bg-blue-600","hover:bg-blue-700"),n.classList.add("bg-gray-600","cursor-not-allowed")):(n.textContent="Add Friend",n.removeAttribute("disabled"))}),document.querySelector(".remove-friend-btn")?.addEventListener("click",async t=>{t.preventDefault(),confirm("Are you sure you want to remove this friend?")&&await St(s)&&Ct(s)});const e=document.createElement("button");e.className="mt-4 px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors text-white font-medium",e.textContent="Back to Search",e.addEventListener("click",()=>h("/search")),document.getElementById("user-profile-actions")?.appendChild(e)}function _o(){S(),v(po),so()}function Ao(){S(),v(vt)}function Po(){if(!I()){h("/");return}S(),v(He),Tt()}function oe(){if(!I()){h("/");return}S(),v(wt)}function h(s){window.location.pathname!==s&&(window.history.pushState({},"",s),$e())}function $e(){const s=window.location.pathname;if(s.startsWith("/user/")){const t=s.split("/").pop();if(t&&!isNaN(parseInt(t))){if(!I()){h("/");return}Bt();return}}const e=Xe.find(t=>t.path===s)||Xe[0];if(e.authRequired&&!I()){h("/");return}if(e.preAuthRequired&&!jo()){h("/");return}e.view()}window.addEventListener("popstate",$e);document.addEventListener("DOMContentLoaded",()=>{S(),Ne(bt),document.body.addEventListener("click",n=>{const i=n.target;i.matches("[data-link]")&&(n.preventDefault(),h(i.getAttribute("href")||"/"))});const s=document.getElementById("options-btn");s&&s.addEventListener("click",n=>{n.preventDefault(),h("/options")});const e=document.getElementById("remote-auth-btn");e&&e.addEventListener("click",async n=>{n.preventDefault();const i=await fetch("/api/auth/42");if(!i.ok)h("/oAuthCallback");else{const{url:r}=await i.json();r?window.location.href=r:h("/oAuthCallback")}});const t=document.getElementById("loginscreen-btn");t&&t.addEventListener("click",n=>{n.preventDefault(),h("/")}),document.addEventListener("click",n=>{n.target.closest("#singlegame-btn")&&(n.preventDefault(),ye(!0,!1))}),document.addEventListener("click",n=>{n.target.closest("#multiplayergame-remote-btn")&&(n.preventDefault(),ye(!1,!0))}),document.addEventListener("click",n=>{n.target.closest("#multiplayergame-local-btn")&&(n.preventDefault(),ye(!1,!1))}),document.body.addEventListener("click",n=>{const i=n.target;if(i.matches("[data-link]")){n.preventDefault();const r=i.getAttribute("href"),a=i.getAttribute("data-link"),c=r||a;c==="/logout"?Ro():c&&h(c)}}),document.addEventListener("click",n=>{const i=n.target;i.closest("#create-tournament-btn")&&(n.preventDefault(),No()),i.closest("#join-tournament-btn")&&(n.preventDefault(),Ze()),i.closest("#start-tournament-btn")&&(n.preventDefault(),Oo()),i.closest("#leave-tournament-btn")&&(n.preventDefault(),Fo())}),document.addEventListener("keypress",n=>{n.target instanceof HTMLInputElement&&n.target.id==="tournament-id-input"&&n.key==="Enter"&&(n.preventDefault(),Ze())}),$e()});pt();document.addEventListener("click",s=>{const e=s.target;if(e.matches("a[data-link]")){s.preventDefault();const t=e.getAttribute("href");t&&h(t);const n=document.querySelector(".main-nav"),i=document.getElementById("close-menu"),r=document.getElementById("hamburger");n&&i&&r&&(n.classList.add("hidden","md:flex"),i.classList.add("hidden"),r.classList.remove("hidden"))}});async function Tt(){try{const s=localStorage.getItem("authToken");if(!s)throw new Error("No authentication token found");const e=await fetch("/api/profile",{headers:{Authorization:`Bearer ${s}`}});if(!e.ok){if(e.status===401){localStorage.removeItem("authToken"),h("/");return}throw new Error(`HTTP error! status: ${e.status}`)}const t=await e.json();if(!t.nickname)throw new Error("Invalid profile data received");const n=t.email??"N/A (Logged in through 42)",i=document.getElementById("profile-nickname"),r=document.getElementById("profile-email");i&&(i.textContent=t.nickname),r&&(r.textContent=n)}catch(s){console.error("Profile data load error:",s),localStorage.removeItem("authToken"),document.querySelector(".main-nav")?.classList.add("hidden"),h("/")}}async function Ro(){try{const s=localStorage.getItem("authToken");s&&await fetch("/api/logout",{method:"POST",headers:{Authorization:`Bearer ${s}`}}),localStorage.removeItem("authToken"),document.querySelector(".main-nav")?.classList.add("hidden"),document.querySelector(".options-page")?.classList.add("hidden"),document.querySelector(".multiplayer-lobby")?.classList.add("hidden"),document.querySelector(".user-search-page")?.classList.add("hidden"),document.querySelector(".user-profile-page")?.classList.add("hidden"),document.querySelector(".tournament-lobby")?.classList.add("hidden"),S(),h("/"),bt.disconnect()}catch{localStorage.removeItem("authToken"),h("/")}}async function ye(s,e){if(!I()){alert("Multiplayer oynamak iin giri yapmalsnz"),h("/");return}const t=R.getInstance(),n=t.getGameInstance();if(n&&n.gameRunning){alert("A game is already running. Please wait for it to finish first.");return}if(!s&&e){v(co),Qe(s,e);try{await t.ensureConnection(),document.getElementById("lobby-status").textContent="Connected to server"}catch{document.getElementById("lobby-status").textContent="Connection failed"}}else v(U),Qe(s,e)}function Mo(s,e,t){try{const n=A.createRoom();A.onGameStart=()=>{v(U),ae(s)}}catch{document.getElementById("lobby-status").textContent="Connection failed"}}function Qe(s,e){const t=document.getElementById("gameCanvas");if(!t)return;const n=R.getInstance(),i=n.getGameInstance();if(i&&i.gameRunning){console.error("setupLobbyUI called while game is running - this should not happen"),alert("A game is already running. Please wait for it to finish first."),oe();return}const r=new et(t,n);if(n.setGameInstance(r),r.isSinglePlayer=s,r.isRemote=e,s||!e){Mo(r);return}document.getElementById("create-room-btn")?.addEventListener("click",async()=>{const a=document.getElementById("lobby-status");a.textContent="Creating room...";try{const c=await n.createRoom();if(c)a.innerHTML=`Room created! ID: <strong class="neon-text-yellow">${c}</strong><br>Waiting for opponent...`,n.onGameStart=()=>{v(U),ae(r)};else throw new Error("No room ID received")}catch(c){console.error("Join room failed:",c),a.textContent="Failed to join room",setTimeout(()=>{oe()},2e3)}}),document.getElementById("join-room-btn")?.addEventListener("click",async()=>{const a=document.getElementById("room-id-input").value.trim();if(!a)return;const c=document.getElementById("lobby-status");c.textContent="Joining room...";try{if(await n.joinRoom(a))c.textContent="Joined successfully! Starting game...",n.onGameStart=()=>{v(U),ae(r)};else throw new Error("Failed to join room")}catch(l){console.error("Join room failed:",l),c.textContent="Failed to join room",setTimeout(()=>{oe()},2e3)}})}function ae(s){const e=window.currentGame;e&&e.stop(),window.currentGame=s}function qo(){v(kt),Ue()}function Ue(){document.getElementById("tournament-status").textContent="Ready to create or join a tournament";const s=document.getElementById("tournament-id-input");s&&(s.value=""),document.getElementById("tournament-info")?.classList.add("hidden"),document.getElementById("tournament-owner-controls")?.classList.add("hidden")}async function No(){try{document.getElementById("tournament-status").textContent="Creating tournament...";const s=await A.createTournament();console.log("Tournament created with data:",s);const e=s.roomId||s.id||"Unknown";_t(e,s),document.getElementById("tournament-status").textContent=`Tournament ${e} created! Share this ID with others.`}catch(s){console.error("Failed to create tournament:",s),document.getElementById("tournament-status").textContent="Failed to create tournament. Please try again."}}async function Ze(){const e=document.getElementById("tournament-id-input").value.trim().toUpperCase();if(!e){alert("Please enter a tournament ID");return}if(e.length<3){alert("Tournament ID must be at least 3 characters");return}try{document.getElementById("tournament-status").textContent=`Joining tournament ${e}...`;const t=await A.joinTournament(e);console.log("Tournament data received:",t),_t(e,t),document.getElementById("tournament-status").textContent=`Joined tournament ${e}`}catch(t){console.error("Failed to join tournament:",t),document.getElementById("tournament-status").textContent="Failed to join tournament. Check ID and try again."}}function _t(s,e){if(document.getElementById("current-tournament-id").textContent=s,document.getElementById("tournament-info")?.classList.remove("hidden"),document.getElementById("tournament-owner-controls")?.classList.remove("hidden"),e&&e.players)console.log("Using real player data:",e.players),ie(e.players);else if(e&&e.room&&e.room.players)console.log("Using nested player data:",e.room.players),ie(e.room.players);else return;ie(e.players)}function ie(s){console.log("Live update - Tournament players changed:",s);let e=s;if(s&&!Array.isArray(s)&&(e=s.players||s.room?.players||[]),!Array.isArray(e)){console.warn("Invalid players data received:",s);return}const t=document.getElementById("tournament-players-list"),n=document.getElementById("tournament-player-count"),i=document.getElementById("start-tournament-btn");t.innerHTML="",console.log("Updating tournament players:",e),e.forEach(r=>{const a=document.createElement("div");a.className="flex justify-between items-center p-2 bg-gray-800 rounded",r.nickname,a.innerHTML=`
      <span class="text-white">${r.nickname}</span>
      <span class="text-xs text-gray-400">Player</span>
    `,t.appendChild(a)}),n.textContent=`${e.length}/5`,i&&(i.disabled=e.length<3,i.textContent=e.length<3?"Start Tournament (Min. 3 players)":`Start Tournament (${e.length} players)`)}async function Oo(){try{document.getElementById("tournament-status").textContent="Starting tournament...";const s=document.getElementById("current-tournament-id").textContent;if(!s||s==="-")throw new Error("No tournament ID found");await A.startTournament(s)}catch(s){console.error("Failed to start tournament:",s),document.getElementById("tournament-status").textContent="Failed to start tournament. Please try again."}}async function Fo(){if(confirm("Are you sure you want to leave the tournament?"))try{await A.leaveTournament(),Ue(),document.getElementById("tournament-status").textContent="Left tournament"}catch(s){console.error("Failed to leave tournament:",s)}}async function Do(){if(!I()){h("/");return}qo();try{await A.ensureConnection(),document.getElementById("tournament-status").textContent="Connected to server - Ready for tournament"}catch(s){console.error("Tournament connection failed:",s),document.getElementById("tournament-status").textContent="Connection failed - tournament unavailable"}}function Ho(s){console.log("[Frontend] Tournament Match Start"),v(U);const e=document.getElementById("gameCanvas");if(!e){console.error("Canvas not found!");return}e.classList.remove("hidden","invisible","opacity-0"),e.style.display="block !important",e.style.visibility="visible !important";const t=new et(e,A);A.setGameInstance(t);const n=s.owner.nickname||s.player1,i=s.guest.nickname||s.player2;if(n&&i){const r=document.getElementById("tournament-status");r&&(r.textContent=`Match: ${n} vs ${i}`)}console.log("Tournament game setup complete, canvas visible"),A.onGameStart=()=>{console.log("Tournament game starting!"),ae(t)}}function $o(s){console.log("Tournament completely finished, winner:",s),v(kt);const e=document.getElementById("tournament-status");e&&(e.textContent=` Tournament finished!
${s.winner} won!`),setTimeout(()=>{Ue()},9e3)}async function Uo(s){try{const e=await fetch("/api/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=e.clone();if(!e.ok){const i=await t.json();throw new Error(i.error||"Authentication failed")}const n=await t.json();return localStorage.setItem("authToken",n.token),Ne(T.getInstance()),n}catch(e){throw console.error("Signup error:",e),e}}async function Go(s){try{const e=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok){const n=await e.json(),i=n.message||n.error||"Login failed";throw new Error(i)}const t=await e.json();if(!t.token)throw new Error("Authentication token not received");localStorage.setItem("authToken",t.token),document.querySelector(".main-nav")?.classList.remove("hidden");try{await R.getInstance().ensureConnection(),console.log("Socket connected after login")}catch(n){console.error("Socket connection error after login:",n)}return h("/profile"),Ne(T.getInstance()),t}catch(e){throw console.error("Login error:",e),localStorage.removeItem("authToken"),document.querySelector(".main-nav")?.classList.add("hidden"),e}}async function zo(s){try{const e=localStorage.getItem("preAuthToken");if(!e)throw new Error("Missing preAuthToken");const t=await fetch("/api/profile/set-nickname",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify(s)});if(!t.ok){const i=await t.json(),r=i.message||i.error||"Setting nickname failed";throw new Error(r)}const n=await t.json();if(!n.success)throw new Error(n.error);if(!n.token)throw new Error("Authentication token not received");localStorage.setItem("authToken",n.token),localStorage.removeItem("preAuthToken"),h("/profile")}catch(e){throw console.error("SetNickname error:",e),document.querySelector(".main-nav")?.classList.add("hidden"),e}}function I(){return!!localStorage.getItem("authToken")}function jo(){return!!localStorage.getItem("preAuthToken")}const Vo=()=>{document.getElementById("loginForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-email").value,n=document.getElementById("login-pw").value;try{await Go({email:t,password:n}),h("/profile")}catch(i){alert(i instanceof Error?i.message:"Login failed")}})},Yo=()=>{document.getElementById("signupForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("signup-nickname").value,n=document.getElementById("signup-email").value,i=document.getElementById("signup-pw").value;if(t.length<3){alert("Nickname should be at least 3 characters!");return}try{await Uo({nickname:t,email:n,password:i}),h("/profile")}catch(r){alert(r instanceof Error?r.message:"Signup failed")}})},Wo=()=>{document.getElementById("nicknameForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("nickname-field").value;if(t.length<3){alert("Nickname should be at least 3 characters!");return}try{await zo({nickname:t}),h("/profile")}catch(n){alert(n instanceof Error?n.message:"Setting nickname failed")}})};function Jo(){const s=document.getElementById("loginForm"),e=document.getElementById("signupForm"),t=document.getElementById("switchToSignup"),n=document.getElementById("switchToLogin");if(document.querySelector(".main-nav")?.classList.add("hidden"),!s||!e||!t||!n){console.warn("Auth toggle elements not found");return}t.addEventListener("click",()=>{s.classList.add("hidden"),e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.remove("hidden")}),n.addEventListener("click",()=>{e.classList.add("hidden"),s.classList.remove("hidden"),n.classList.add("hidden"),t.classList.remove("hidden")}),Vo(),Yo(),Wo()}function Xo(){S(),Jo(),pt();const s=window.location.pathname;["/profile","/game","/tournament"].includes(s)&&!localStorage.getItem("authToken")&&h("/")}document.addEventListener("DOMContentLoaded",Xo);
